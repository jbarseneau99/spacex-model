<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaceX Valuation Platform | 33fg.com</title>
    <link rel="stylesheet" href="/css/main.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="logo-section">
                <img src="/33fg_logo.png" alt="33fg Logo" class="logo-icon">
                <div class="logo-text">
                    <h1>SpaceX Valuation Platform</h1>
                    <span class="branding">33fg.com</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="icon-button" id="helpBtn" title="Help & Methodology">
                    <i data-lucide="help-circle"></i>
                </button>
                <button class="icon-button" id="aiAgentBtn" title="Desktop Agent">
                    <i data-lucide="bot"></i>
                </button>
                <button class="icon-button" id="settingsBtn" title="Settings">
                    <i data-lucide="settings"></i>
                </button>
                <button class="icon-button" id="exportBtn" title="Export">
                    <i data-lucide="download"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <nav class="nav-menu">
                <!-- Main Views Group -->
                <a href="#models" class="nav-item" data-view="models">
                    <i data-lucide="database"></i>
                    <span>Saved Models</span>
                </a>
                <a href="#dashboard" class="nav-item active" data-view="dashboard">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Model Valuation</span>
                </a>
                <a href="#insights" class="nav-item" data-view="insights">
                    <i data-lucide="lightbulb"></i>
                    <span>Insights</span>
                </a>
                <a href="#charts" class="nav-item" data-view="charts">
                    <i data-lucide="bar-chart-2"></i>
                    <span>Charts</span>
                </a>
                <a href="#ratios" class="nav-item" data-view="ratios">
                    <i data-lucide="percent"></i>
                    <span>Ratios & Comparables</span>
                </a>
                
                <!-- Divider -->
                <div class="nav-divider"></div>
                
                <!-- Operations Group -->
                <a href="#earth" class="nav-item" data-view="earth">
                    <i data-lucide="globe"></i>
                    <span>Earth Operations</span>
                </a>
                <a href="#mars" class="nav-item" data-view="mars">
                    <i data-lucide="globe"></i>
                    <span>Mars Operations</span>
                </a>
                
                <!-- Divider -->
                <div class="nav-divider"></div>
                
                <!-- Risk Group -->
                <a href="#scenarios" class="nav-item" data-view="scenarios">
                    <i data-lucide="layers"></i>
                    <span>Scenarios</span>
                </a>
                <a href="#stress" class="nav-item" data-view="stress">
                    <i data-lucide="alert-triangle"></i>
                    <span>Stress Testing</span>
                </a>
                <a href="#sensitivity" class="nav-item" data-view="sensitivity">
                    <i data-lucide="trending-up"></i>
                    <span>Sensitivity Curves</span>
                </a>
                <a href="#greeks" class="nav-item" data-view="greeks">
                    <i data-lucide="sigma"></i>
                    <span>Financial Greeks</span>
                </a>
                <a href="#factor-risk" class="nav-item" data-view="factor-risk">
                    <i data-lucide="layers"></i>
                    <span>Factor Risk</span>
                </a>
                <a href="#attribution" class="nav-item" data-view="attribution">
                    <i data-lucide="pie-chart"></i>
                    <span>PnL Attribution</span>
                </a>
                <a href="#var" class="nav-item" data-view="var">
                    <i data-lucide="alert-octagon"></i>
                    <span>Value at Risk (VaR)</span>
                </a>
                
                <!-- Divider -->
                <div class="nav-divider"></div>
                
                <!-- Data Management Group -->
                <a href="#monte-carlo" class="nav-item" data-view="monte-carlo">
                    <i data-lucide="dice-6"></i>
                    <span>Monte Carlo</span>
                </a>
                <a href="#inputs" class="nav-item" data-view="inputs">
                    <i data-lucide="database"></i>
                    <span>Reference Data</span>
                </a>
            </nav>
        </aside>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Dashboard View -->
            <div id="dashboard" class="view active">
                <div class="view-header">
                    <h2>Valuation Dashboard</h2>
                    <button class="btn btn-primary" id="calculateBtn">
                        <i data-lucide="dice-6"></i>
                        Run Monte Carlo Simulation
                    </button>
                </div>

                <!-- Key Metrics -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-label">Total Enterprise Value</span>
                            <i data-lucide="dollar-sign" class="metric-icon"></i>
                        </div>
                        <div class="metric-value" id="totalValue">$0.0B</div>
                        <div class="metric-change" id="totalChange">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-label">Earth Operations</span>
                            <i data-lucide="globe" class="metric-icon"></i>
                        </div>
                        <div class="metric-value" id="earthValue">$0.0B</div>
                        <div class="metric-percent" id="earthPercent">--%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-label">Mars Operations</span>
                            <i data-lucide="globe" class="metric-icon"></i>
                        </div>
                        <div class="metric-value" id="marsValue">$0.0B</div>
                        <div class="metric-percent" id="marsPercent">--%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-label">Mars Option Value</span>
                            <i data-lucide="zap" class="metric-icon"></i>
                        </div>
                        <div class="metric-value" id="marsOptionValue">$0.0B</div>
                        <div class="metric-subtitle">Real Options</div>
                    </div>
                </div>

                <!-- Charts Side by Side -->
                <div class="section">
                    <div class="charts-row">
                        <div class="chart-container-half">
                            <h3>Valuation Breakdown</h3>
                            <canvas id="valuationChart"></canvas>
                        </div>
                        <div class="chart-container-half">
                            <h3>Cash Flow Timeline</h3>
                            <canvas id="cashFlowTimelineChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Panel -->
                <div class="section" id="aiInsightsSection" style="display: none;">
                    <div class="section-header">
                        <h3><i data-lucide="sparkles"></i> AI Analysis & Insights</h3>
                        <button class="btn btn-secondary btn-sm" id="refreshInsightsBtn">
                            <i data-lucide="refresh-cw"></i>
                            Refresh
                        </button>
                    </div>
                    <div id="aiInsightsContent" class="ai-content">
                        <div class="loading-state">Generating insights...</div>
                    </div>
                </div>

                <!-- Revenue Breakdown -->
                <div class="section" id="revenueBreakdownSection" style="display: none;">
                    <h3><i data-lucide="pie-chart"></i> Revenue Breakdown</h3>
                    <div class="chart-container">
                        <canvas id="revenueBreakdownChart"></canvas>
                    </div>
                </div>

                <!-- Detailed Metrics -->
                <div class="section" id="detailedMetricsSection" style="display: none;">
                    <h3><i data-lucide="bar-chart-3"></i> Detailed Metrics</h3>
                    <div class="metrics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div class="metric-card-small">
                            <div class="metric-label">Active Satellites</div>
                            <div class="metric-value-small" id="activeSatellites">--</div>
                        </div>
                        <div class="metric-card-small">
                            <div class="metric-label">Bandwidth Capacity</div>
                            <div class="metric-value-small" id="bandwidthCapacity">--</div>
                        </div>
                        <div class="metric-card-small">
                            <div class="metric-label">Rockets Available</div>
                            <div class="metric-value-small" id="rocketsAvailable">--</div>
                        </div>
                        <div class="metric-card-small">
                            <div class="metric-label">Annual Capex</div>
                            <div class="metric-value-small" id="annualCapex">--</div>
                        </div>
                    </div>
                </div>

                <!-- Cash Flow Projection -->
                <div class="section">
                    <h3>Earth Cash Flow Projection</h3>
                    <div class="table-container">
                        <table id="cashFlowTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Revenue</th>
                                    <th>Costs</th>
                                    <th>Capex</th>
                                    <th>Cash Flow</th>
                                    <th>PV</th>
                                    <th>Cumulative PV</th>
                                </tr>
                            </thead>
                            <tbody id="cashFlowBody">
                                <tr><td colspan="7" class="empty-state">Run calculation to see projections</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Inputs View (Reference Data) -->
            <div id="inputs" class="view">
                <div class="view-header">
                    <h2>Reference Data</h2>
                </div>

                <!-- Reference Data Tabs -->
                <div class="insights-tabs" style="display: flex; gap: 8px; padding: 0 var(--spacing-lg); margin-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-color);">
                    <button class="insights-tab active" data-tab="basic-inputs">
                        <i data-lucide="sliders-horizontal"></i>
                        <span>Basic Parameters</span>
                    </button>
                    <button class="insights-tab" data-tab="advanced-earth">
                        <i data-lucide="rocket"></i>
                        <span>Advanced Earth Operations</span>
                    </button>
                    <button class="insights-tab" data-tab="advanced-mars">
                        <i data-lucide="globe"></i>
                        <span>Advanced Mars Operations</span>
                    </button>
                    <button class="insights-tab" data-tab="tam-data">
                        <i data-lucide="table"></i>
                        <span>Earth Bandwidth TAM</span>
                    </button>
                    <button class="insights-tab" data-tab="tam-methodology">
                        <i data-lucide="book-open"></i>
                        <span>TAM Methodology</span>
                    </button>
                </div>

                <!-- Basic Parameters Tab Content -->
                <div id="referenceTab-basic-inputs" class="insights-tab-content active">
                        <div class="inputs-grid">
                            <!-- Earth Inputs -->
                            <div class="input-section">
                                <h3><i data-lucide="globe"></i> Earth Operations</h3>
                                <div class="form-group">
                                    <label>Starlink Penetration Rate</label>
                                    <input type="number" id="starlinkPenetration" value="0.15" step="0.01" min="0" max="1">
                                    <span class="input-hint">Annual growth rate for Starlink capacity</span>
                                </div>
                                <div class="form-group">
                                    <label>Bandwidth Price Decline</label>
                                    <input type="number" id="bandwidthPriceDecline" value="0.10" step="0.01" min="0" max="1">
                                    <span class="input-hint">Annual price decline rate</span>
                                </div>
                                <div class="form-group">
                                    <label>Launch Volume (Base)</label>
                                    <input type="number" id="launchVolume" value="100" step="1" min="0">
                                    <span class="input-hint">Annual launches</span>
                                </div>
                                <div class="form-group">
                                    <label>Launch Price Decline</label>
                                    <input type="number" id="launchPriceDecline" value="0.05" step="0.01" min="0" max="1">
                                    <span class="input-hint">Annual price decline rate</span>
                                </div>
                            </div>

                            <!-- Mars Inputs -->
                            <div class="input-section">
                                <h3><i data-lucide="globe"></i> Mars Operations</h3>
                                <div class="form-group">
                                    <label>First Colony Year</label>
                                    <input type="number" id="firstColonyYear" value="2030" step="1" min="2025" max="2050">
                                    <span class="input-hint">Year of first permanent settlement</span>
                                </div>
                                <div class="form-group">
                                    <label>Transport Cost Decline</label>
                                    <input type="number" id="transportCostDecline" value="0.20" step="0.01" min="0" max="1">
                                    <span class="input-hint">Annual cost reduction rate</span>
                                </div>
                                <div class="form-group">
                                    <label>Population Growth Rate</label>
                                    <input type="number" id="populationGrowth" value="0.50" step="0.01" min="0" max="2">
                                    <span class="input-hint">Annual population growth</span>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="industrialBootstrap" checked>
                                        Industrial Bootstrapping
                                    </label>
                                    <span class="input-hint">Self-sustaining industrial base</span>
                                </div>
                            </div>

                            <!-- Financial Inputs -->
                            <div class="input-section">
                                <h3><i data-lucide="dollar-sign"></i> Financial Parameters</h3>
                                <div class="form-group">
                                    <label>Discount Rate</label>
                                    <input type="number" id="discountRate" value="0.12" step="0.01" min="0" max="1">
                                    <span class="input-hint">WACC / required return</span>
                                </div>
                                <div class="form-group">
                                    <label>Dilution Factor</label>
                                    <input type="number" id="dilutionFactor" value="0.15" step="0.01" min="0" max="1">
                                    <span class="input-hint">Expected future dilution</span>
                                </div>
                                <div class="form-group">
                                    <label>Terminal Growth Rate</label>
                                    <input type="number" id="terminalGrowth" value="0.03" step="0.01" min="0" max="0.1">
                                    <span class="input-hint">Perpetual growth rate</span>
                                </div>
                            </div>
                        </div>
                </div>

                <!-- Advanced Earth Operations Tab Content -->
                <div id="referenceTab-advanced-earth" class="insights-tab-content" style="display: none;">
                        <div class="inputs-grid">
                            <!-- Starship Configuration -->
                            <div class="input-section">
                                <h3><i data-lucide="rocket"></i> Starship Configuration</h3>
                                <div class="form-group">
                                    <label>Starship Reusability Year</label>
                                    <input type="number" id="starshipReusabilityYear" value="2026" step="1" min="2020" max="2035">
                                    <span class="input-hint">Year Starship becomes reusable</span>
                                </div>
                                <div class="form-group">
                                    <label>Starship Commercial Viability Year</label>
                                    <input type="number" id="starshipCommercialViabilityYear" value="2025" step="1" min="2020" max="2035">
                                    <span class="input-hint">Year Starship becomes commercially viable</span>
                                </div>
                                <div class="form-group">
                                    <label>Starship Payload Capacity (2030) - kg</label>
                                    <input type="number" id="starshipPayloadCapacity" value="75000" step="1000" min="50000" max="250000">
                                    <span class="input-hint">Payload capacity in kilograms by 2030</span>
                                </div>
                                <div class="form-group">
                                    <label>Maximum Annual Rocket Production Increase</label>
                                    <input type="number" id="maxRocketProductionIncrease" value="0.25" step="0.05" min="0" max="2">
                                    <span class="input-hint">Maximum annual increase in rockets manufactured (as multiplier)</span>
                                </div>
                            </div>

                            <!-- Wright's Law Parameters -->
                            <div class="input-section">
                                <h3><i data-lucide="trending-down"></i> Wright's Law Parameters</h3>
                                <div class="form-group">
                                    <label>Wright's Law - Turnaround Time %</label>
                                    <input type="number" id="wrightsLawTurnaroundTime" value="0.05" step="0.01" min="0" max="0.5">
                                    <span class="input-hint">% applied to turnaround time per cumulative doubling in upmass</span>
                                </div>
                                <div class="form-group">
                                    <label>Wright's Law - Launch Cost/kg %</label>
                                    <input type="number" id="wrightsLawLaunchCost" value="0.05" step="0.01" min="0" max="0.5">
                                    <span class="input-hint">% applied to launch cost/kg per cumulative doubling in upmass</span>
                                </div>
                                <div class="form-group">
                                    <label>Wright's Law - Satellite GBPS/kg %</label>
                                    <input type="number" id="wrightsLawSatelliteGBPS" value="0.07" step="0.01" min="0" max="0.3">
                                    <span class="input-hint">% applied to satellite GBPS/kg per cumulative doubling in bandwidth</span>
                                </div>
                            </div>

                            <!-- Market & Operations -->
                            <div class="input-section">
                                <h3><i data-lucide="bar-chart"></i> Market & Operations</h3>
                                <div class="form-group">
                                    <label>Realized Bandwidth TAM Multiplier</label>
                                    <input type="number" id="realizedBandwidthTAMMultiplier" value="0.5" step="0.05" min="0" max="2">
                                    <span class="input-hint">Realized TAM relative to modeled Bandwidth TAM</span>
                                </div>
                                <div class="form-group">
                                    <label>% Starship Launches for Starlink (2030)</label>
                                    <input type="number" id="starshipLaunchesForStarlink" value="0.9" step="0.01" min="0" max="1">
                                    <span class="input-hint">Percentage of Starship launches dedicated to Starlink vs customers</span>
                                </div>
                                <div class="form-group">
                                    <label>Non-Starlink Launch Market Growth Rate</label>
                                    <input type="number" id="nonStarlinkLaunchMarketGrowth" value="0.01" step="0.01" min="0" max="0.2">
                                    <span class="input-hint">Annual growth rate of non-Starlink launch market</span>
                                </div>
                                <div class="form-group">
                                    <label>IRR Threshold for Earth→Mars Switch</label>
                                    <input type="number" id="irrThresholdEarthToMars" value="0" step="0.01" min="0" max="0.2">
                                    <span class="input-hint">IRR % threshold to switch focus from Earth to Mars operations</span>
                                </div>
                                <div class="form-group">
                                    <label>Cash Buffer %</label>
                                    <input type="number" id="cashBufferPercent" value="0.1" step="0.05" min="0" max="0.5">
                                    <span class="input-hint">Percentage of start-of-year cash that is buffered</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Mars Operations Tab Content -->
                <div id="referenceTab-advanced-mars" class="insights-tab-content" style="display: none;">
                        <div class="inputs-grid">
                            <!-- Optimus Robot Configuration -->
                            <div class="input-section">
                                <h3><i data-lucide="bot"></i> Optimus Robot Configuration</h3>
                                <div class="form-group">
                                    <label>Optimus Cost (2026) - $</label>
                                    <input type="number" id="optimusCost2026" value="50000" step="1000" min="10000" max="500000">
                                    <span class="input-hint">Cost of a Mars-capable Optimus robot in 2026</span>
                                </div>
                                <div class="form-group">
                                    <label>Optimus Annual Cost Decline</label>
                                    <input type="number" id="optimusAnnualCostDecline" value="0.05" step="0.01" min="0" max="0.3">
                                    <span class="input-hint">Annual cost reduction rate for Optimus</span>
                                </div>
                                <div class="form-group">
                                    <label>Optimus Productivity Multiplier</label>
                                    <input type="number" id="optimusProductivityMultiplier" value="0.25" step="0.05" min="0.1" max="3">
                                    <span class="input-hint">Productivity per labor hour relative to US construction worker</span>
                                </div>
                                <div class="form-group">
                                    <label>Optimus Learning Rate Productivity Improvement</label>
                                    <input type="number" id="optimusLearningRate" value="0.05" step="0.01" min="0" max="1">
                                    <span class="input-hint">Learning rate for productivity improvement over time</span>
                                </div>
                            </div>

                            <!-- Mars Payload Configuration -->
                            <div class="input-section">
                                <h3><i data-lucide="package"></i> Mars Payload Configuration</h3>
                                <div class="form-group">
                                    <label>% Mars Payload: Optimus vs Tooling</label>
                                    <input type="number" id="marsPayloadOptimusVsTooling" value="0.01" step="0.05" min="0" max="1">
                                    <span class="input-hint">Percentage of Mars-bound payload weight that is Optimus robots vs tooling for Optimus to use</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions Bar (shown only on input tabs) -->
                <div id="referenceDataActionsBar" class="actions-bar" style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--border-color); display: none;">
                    <button class="btn btn-primary" id="saveInputsBtn">
                        <i data-lucide="save"></i>
                        Save Inputs
                    </button>
                    <button class="btn btn-secondary" id="resetInputsBtn">
                        <i data-lucide="rotate-ccw"></i>
                        Reset to Defaults
                    </button>
                </div>

                <!-- Earth Bandwidth TAM Tab Content -->
                <div id="referenceTab-tam-data" class="insights-tab-content" style="display: none;">
                    <div class="section">
                        <h3><i data-lucide="signal"></i> Earth Bandwidth TAM Lookup Table</h3>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md);">
                            Total Addressable Market data for bandwidth pricing. <strong>Values are generated</strong> using the Satellite Broadband Revenue Demand model methodology. Used in bandwidth price calculations via lookup and interpolation.
                        </p>
                        
                        <div class="table-container" style="max-height: 600px; overflow-y: auto;">
                            <table class="data-table" id="tamDataTable">
                                <thead>
                                    <tr>
                                        <th style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 10;">Key (Capacity)</th>
                                        <th style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 10;">TAM Value</th>
                                    </tr>
                                </thead>
                                <tbody id="tamDataTableBody">
                                    <tr>
                                        <td colspan="2" class="empty-state">Loading TAM data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: rgba(0, 102, 204, 0.1); border-left: 3px solid #0066cc; border-radius: var(--radius);">
                            <p id="tamDataNote" style="margin: 0; font-size: 14px; color: var(--text-secondary);">
                                <strong>Note:</strong> Loading TAM data...
                            </p>
                        </div>
                        
                        <div class="actions-bar" style="margin-top: var(--spacing-lg);">
                            <button class="btn btn-primary" id="regenerateTAMBtn">
                                <i data-lucide="refresh-cw"></i>
                                Regenerate TAM Data
                            </button>
                            <span id="tamRegenerateStatus" style="margin-left: var(--spacing-md); font-size: 14px; color: var(--text-secondary);"></span>
                        </div>
                    </div>
                </div>

                <!-- TAM Methodology Tab Content -->
                <div id="referenceTab-tam-methodology" class="insights-tab-content" style="display: none;">
                    <div class="section">
                        <h3><i data-lucide="book-open"></i> Satellite Broadband Revenue Demand Model</h3>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md);">
                            The Earth Bandwidth TAM lookup table is generated using the Satellite Broadband Revenue Demand model methodology. This model calculates potential revenue based on satellite capacity, geographic distribution, and market economics.
                        </p>

                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin: 0 0 var(--spacing-md) 0; font-size: 16px; color: var(--text-primary);">
                                <i data-lucide="settings"></i> Model Inputs
                            </h4>
                            <div style="background: var(--bg-secondary); padding: var(--spacing-md); border-radius: var(--radius); margin-bottom: var(--spacing-md);">
                                <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 14px; line-height: 1.8;">
                                    <li><strong>Number of Satellites</strong> - Total satellites in constellation</li>
                                    <li><strong>Downlink Bandwidth per Satellite</strong> - Bandwidth capacity per satellite</li>
                                    <li><strong>Oversubscription Ratio</strong> - Ratio of potential users to available bandwidth (typically 10:1)</li>
                                    <li><strong>Minimum Acceptable Bandwidth</strong> - Minimum bandwidth per user (~5 Mbps)</li>
                                    <li><strong>Acceptable Price of Broadband as % of GNI per Capita</strong> - Maximum affordable price (typically 2%)</li>
                                </ul>
                            </div>
                        </div>

                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin: 0 0 var(--spacing-md) 0; font-size: 16px; color: var(--text-primary);">
                                <i data-lucide="git-branch"></i> Model Logic
                            </h4>
                            <div style="background: var(--bg-secondary); padding: var(--spacing-md); border-radius: var(--radius);">
                                <ol style="margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 14px; line-height: 1.8;">
                                    <li><strong>Total Bandwidth Calculation:</strong><br>
                                        <code style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px;">Bandwidth = Satellites × Downlink Bandwidth per Satellite</code>
                                    </li>
                                    <li><strong>Geographic Distribution:</strong><br>
                                        Assumes satellites evenly distributed over globe.<br>
                                        <code style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px;">Bandwidth Available Over Each Country = Land Area as % of Earth × Total Bandwidth</code>
                                    </li>
                                    <li><strong>Potential Users Calculation:</strong><br>
                                        <code style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px;">Potential Rural Users = (Available Bandwidth / Minimum Bandwidth) × Oversubscription Ratio</code><br>
                                        Constrained by actual rural population.
                                    </li>
                                    <li><strong>Household Conversion:</strong><br>
                                        <code style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px;">Number of Households = Potential Users / Average Household Size</code>
                                    </li>
                                    <li><strong>Acceptable Broadband Cost:</strong><br>
                                        <code style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px;">Acceptable Cost = GNI per Capita × Household Size × Acceptable Price %</code>
                                    </li>
                                    <li><strong>Revenue Calculation:</strong><br>
                                        <code style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px;">Potential Revenue = MIN(Acceptable Cost, Current Broadband Price) × Number of Households</code>
                                    </li>
                                    <li><strong>Urban Areas:</strong><br>
                                        Same calculation repeated for urban areas and urban population.
                                    </li>
                                </ol>
                            </div>
                        </div>

                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin: 0 0 var(--spacing-md) 0; font-size: 16px; color: var(--text-primary);">
                                <i data-lucide="info"></i> Data Generation
                            </h4>
                            <div style="padding: var(--spacing-md); background: rgba(0, 102, 204, 0.1); border-left: 3px solid #0066cc; border-radius: var(--radius);">
                                <p style="margin: 0 0 var(--spacing-sm) 0; font-size: 14px; color: var(--text-secondary);">
                                    <strong>Note:</strong> The TAM lookup table values are <strong>generated</strong> using this model methodology, not static input data. The model calculates potential revenue for capacity values ranging from 100,000 to 1,000,000,000 Gbps, creating a lookup table used in bandwidth price calculations.
                                </p>
                                <p style="margin: var(--spacing-sm) 0 0 0; font-size: 14px; color: var(--text-secondary);">
                                    <strong>Source:</strong> Based on the Satellite Broadband Revenue Demand model methodology from GitHub. The model accounts for global satellite distribution, country-level demographics, GNI per capita, and broadband affordability constraints.
                                </p>
                            </div>
                        </div>

                        <div style="padding-top: var(--spacing-lg); border-top: 1px solid var(--border-color);">
                            <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">
                                You can regenerate the TAM lookup table using the model methodology. Use the "Regenerate TAM Data" button in the "Earth Bandwidth TAM" tab.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Earth View -->
            <div id="earth" class="view">
                <div class="view-header">
                    <h2>Earth Operations Analysis</h2>
                </div>

                <!-- Earth Operations Sub-Tabs -->
                <div class="insights-tabs" style="display: flex; gap: 8px; padding: 0 var(--spacing-lg); margin-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-color);">
                    <button class="insights-tab active" data-earth-tab="starlink">
                        <i data-lucide="satellite"></i>
                        <span>Starlink</span>
                    </button>
                    <button class="insights-tab" data-earth-tab="launch">
                        <i data-lucide="rocket"></i>
                        <span>Launch Services</span>
                    </button>
                    <button class="insights-tab" data-earth-tab="utilization">
                        <i data-lucide="activity"></i>
                        <span>Utilization Metrics</span>
                    </button>
                    <button class="insights-tab" data-earth-tab="cadence">
                        <i data-lucide="trending-up"></i>
                        <span>Launch Cadence</span>
                    </button>
                    <button class="insights-tab" data-earth-tab="technology">
                        <i data-lucide="refresh-cw"></i>
                        <span>Technology</span>
                    </button>
                    <button class="insights-tab" data-earth-tab="financials">
                        <i data-lucide="trending-up"></i>
                        <span>Financials</span>
                    </button>
                </div>

                <!-- Starlink Tab Content -->
                <div id="earthTab-starlink" class="insights-tab-content active">
                <!-- Starlink Analysis -->
                <div class="section" style="margin-bottom: var(--spacing-md);">
                    <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="satellite"></i> Starlink Operations</h3>
                    <div class="metrics-grid-small">
                        <div class="metric-card-small">
                            <span class="metric-label-small">Bandwidth Capacity</span>
                            <span class="metric-value-small" id="starlinkCapacity">--</span>
                        </div>
                        <div class="metric-card-small">
                            <span class="metric-label-small">Bandwidth Price</span>
                            <span class="metric-value-small" id="starlinkPrice">--</span>
                        </div>
                        <div class="metric-card-small">
                            <span class="metric-label-small">Starlink Revenue</span>
                            <span class="metric-value-small" id="starlinkRevenue">--</span>
                        </div>
                        <div class="metric-card-small">
                            <span class="metric-label-small">Starshield Revenue</span>
                            <span class="metric-value-small" id="starshieldRevenue">--</span>
                        </div>
                    </div>
                    <div class="chart-container" style="background: #1a1a1a; border-radius: var(--radius); padding: var(--spacing-md);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="margin: 0; color: white; font-size: 14px; font-weight: 600;">Starlink Network Scaling Curve Projection</h4>
                            <div style="display: flex; gap: 8px;">
                                <button class="scenario-btn" data-scenario="bear" style="background: #2a2a2a; color: #888; border: 1px solid #444; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Bear</button>
                                <button class="scenario-btn active" data-scenario="base" style="background: white; color: #0066cc; border: 1px solid #0066cc; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500;">Base</button>
                                <button class="scenario-btn" data-scenario="bull" style="background: #2a2a2a; color: #888; border: 1px solid #444; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Bull</button>
                            </div>
                        </div>
                        <canvas id="starlinkChart"></canvas>
                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 12px; padding-left: 12px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #10b981;"></div>
                            <span style="color: #888; font-size: 12px;">Bandwidth</span>
                        </div>
                    </div>
                </div>

                <!-- Bandwidth Economics -->
                <div class="section" style="margin-bottom: var(--spacing-md);">
                    <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="signal"></i> Bandwidth Economics</h3>
                    <div class="metrics-grid-small">
                        <div class="metric-card-small">
                            <span class="metric-label-small">Revenue per Gbps</span>
                            <span class="metric-value-small" id="revenuePerGbps">--</span>
                        </div>
                        <div class="metric-card-small">
                            <span class="metric-label-small">Bandwidth Utilization</span>
                            <span class="metric-value-small" id="bandwidthUtilization">--</span>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="bandwidthEconomicsChart"></canvas>
                    </div>
                </div>
                </div>

                <!-- Launch Services Tab Content -->
                <div id="earthTab-launch" class="insights-tab-content">
                <!-- Launch Services -->
                <div class="section" style="margin-bottom: var(--spacing-md);">
                    <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="rocket"></i> Launch Services</h3>
                    <div class="metrics-grid-small">
                        <div class="metric-card-small">
                            <span class="metric-label-small">Annual Launches</span>
                            <span class="metric-value-small" id="launchVolumeDisplay">--</span>
                        </div>
                        <div class="metric-card-small">
                            <span class="metric-label-small">Price per Launch</span>
                            <span class="metric-value-small" id="launchPriceDisplay">--</span>
                        </div>
                        <div class="metric-card-small">
                            <span class="metric-label-small">Total Launch Revenue</span>
                            <span class="metric-value-small" id="launchRevenue">--</span>
                        </div>
                        <div class="metric-card-small">
                            <span class="metric-label-small">Starship Revenue</span>
                            <span class="metric-value-small" id="starshipRevenue">--</span>
                        </div>
                        <div class="metric-card-small">
                            <span class="metric-label-small">Falcon 9 Revenue</span>
                            <span class="metric-value-small" id="falcon9Revenue">--</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="launchChart"></canvas>
                    </div>
                </div>
                </div>

                <!-- Utilization Metrics Tab Content -->
                <div id="earthTab-utilization" class="insights-tab-content">
                <!-- Utilization Metrics -->
                <div class="section" style="margin-bottom: var(--spacing-md);">
                    <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="activity"></i> Utilization Metrics</h3>
                    <div class="metrics-grid-small">
                        <div class="metric-card-small">
                            <span class="metric-label-small">Rocket Utilization</span>
                            <span class="metric-value-small" id="rocketUtilization">--</span>
                        </div>
                        <div class="metric-card-small">
                            <span class="metric-label-small">Capacity Utilization</span>
                            <span class="metric-value-small" id="capacityUtilization">--</span>
                        </div>
                        <div class="metric-card-small">
                            <span class="metric-label-small">Falcon 9 Utilization</span>
                            <span class="metric-value-small" id="falcon9Utilization">--</span>
                        </div>
                        <div class="metric-card-small">
                            <span class="metric-label-small">Starship Utilization</span>
                            <span class="metric-value-small" id="starshipUtilization">--</span>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="utilizationChart"></canvas>
                    </div>
                </div>
                </div>

                <!-- Launch Cadence Tab Content -->
                <div id="earthTab-cadence" class="insights-tab-content">
                <!-- Launch Cadence -->
                <div class="section" style="margin-bottom: var(--spacing-md);">
                    <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="rocket"></i> Launch Cadence</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md); line-height: 1.6;">
                        Launches per rocket per year shows fleet utilization efficiency. Higher utilization indicates better capital efficiency and faster payback.
                    </p>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="launchCadenceChart"></canvas>
                    </div>
                </div>
                </div>

                <!-- Technology Tab Content -->
                <div id="earthTab-technology" class="insights-tab-content">
                <!-- Technology Transition -->
                <div class="section" style="margin-bottom: var(--spacing-md);">
                    <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="refresh-cw"></i> Technology Transition</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md); line-height: 1.6;">
                        Evolution from Starlink v2 to v3 satellites increases bandwidth capacity per satellite and improves cost efficiency.
                    </p>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="technologyTransitionChart"></canvas>
                    </div>
                </div>
                </div>

                <!-- Financials Tab Content -->
                <div id="earthTab-financials" class="insights-tab-content">
                <!-- Cash Flow Details -->
                <div class="section" style="margin-bottom: var(--spacing-md);">
                    <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="trending-up"></i> Cash Flow Projection</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Starlink Revenue</th>
                                    <th>Launch Revenue</th>
                                    <th>Total Revenue</th>
                                    <th>Costs</th>
                                    <th>Cash Flow</th>
                                    <th>PV</th>
                                </tr>
                            </thead>
                            <tbody id="earthCashFlowBody">
                                <tr><td colspan="7" class="empty-state">Run calculation to see projections</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>
            </div>

            <!-- Mars View -->
            <div id="mars" class="view">
                <div class="view-header">
                    <h2>Mars Operations Analysis</h2>
                </div>

                <!-- Mars Operations Sub-Tabs -->
                <div class="insights-tabs" style="display: flex; gap: 8px; padding: 0 var(--spacing-lg); margin-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-color);">
                    <button class="insights-tab active" data-mars-tab="overview">
                        <i data-lucide="layout-dashboard"></i>
                        <span>Overview</span>
                    </button>
                    <button class="insights-tab" data-mars-tab="launch-scaling">
                        <i data-lucide="rocket"></i>
                        <span>Launch Scaling</span>
                    </button>
                    <button class="insights-tab" data-mars-tab="scenarios">
                        <i data-lucide="layers"></i>
                        <span>Scenarios</span>
                    </button>
                </div>

                <!-- Overview Tab Content -->
                <div id="marsTab-overview" class="insights-tab-content active">
                <!-- Top Row: Metrics + Scenario Analysis -->
                <div class="section" style="margin-bottom: var(--spacing-md);">
                    <div class="mars-top-row">
                        <div class="mars-metric-box">
                            <div class="mars-metric-header">
                                <i data-lucide="zap" style="width: 16px; height: 16px;"></i>
                                <span>Option Value</span>
                            </div>
                            <div class="mars-metric-value" id="marsOptionValueDetail">$0.0B</div>
                            <div class="mars-metric-subtitle">Black-Scholes Call Option</div>
                        </div>
                        <div class="mars-metric-box">
                            <div class="mars-metric-header">
                                <i data-lucide="target" style="width: 16px; height: 16px;"></i>
                                <span>Expected Value</span>
                            </div>
                            <div class="mars-metric-value" id="marsExpectedValue">$0.0B</div>
                            <div class="mars-metric-subtitle">Probability-Weighted</div>
                        </div>
                        <div class="mars-scenario-box">
                            <div class="mars-metric-header">
                                <i data-lucide="layers" style="width: 16px; height: 16px;"></i>
                                <span>Scenario Analysis</span>
                            </div>
                            <div class="scenarios-grid-compact" id="marsScenariosGrid" style="gap: var(--spacing-xs);">
                                <!-- Scenarios will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                    <div class="mars-secondary-metrics">
                        <div class="mars-secondary-item">
                            <span class="mars-secondary-label">Underlying Value</span>
                            <span class="mars-secondary-value" id="marsUnderlyingValue">$0.0B</span>
                        </div>
                        <div class="mars-secondary-item">
                            <span class="mars-secondary-label">Years to Colony</span>
                            <span class="mars-secondary-value" id="marsYearsToColony">--</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Row - Directly Below -->
                <div class="section" style="margin-bottom: var(--spacing-md);">
                    <div class="charts-row" style="gap: var(--spacing-md);">
                        <div class="chart-container-half">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="chart-line"></i> Option Payoff Structure</h3>
                            <canvas id="marsOptionChart"></canvas>
                        </div>
                        <div class="chart-container-half">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="users"></i> Population Projection</h3>
                            <canvas id="marsPopulationChart"></canvas>
                        </div>
                    </div>
                </div>
                </div>

                <!-- Launch Scaling Tab Content -->
                <div id="marsTab-launch-scaling" class="insights-tab-content">
                <!-- Mars Launch Scaling Chart -->
                <div class="section" style="margin-bottom: var(--spacing-md);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 style="margin: 0; font-size: 16px;"><i data-lucide="rocket"></i> Mars Launch Scaling — When Cash Meets Conviction</h3>
                        <div style="display: flex; gap: 8px;">
                            <button class="mars-scaling-scenario-btn" data-scenario="bear" style="background: #2a2a2a; color: #888; border: 1px solid #444; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Bear</button>
                            <button class="mars-scaling-scenario-btn active" data-scenario="base" style="background: white; color: #0066cc; border: 1px solid #0066cc; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500;">Base</button>
                            <button class="mars-scaling-scenario-btn" data-scenario="bull" style="background: #2a2a2a; color: #888; border: 1px solid #444; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Bull</button>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md); line-height: 1.6;">
                        Falling transport costs coincide with sharp ~2-year spikes in Starship flights, illustrating the cost-to-cadence feedback loop.
                    </p>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="marsLaunchScalingChart"></canvas>
                    </div>
                </div>
                </div>

                <!-- Scenarios Tab Content -->
                <div id="marsTab-scenarios" class="insights-tab-content">
                <!-- Scenario Analysis Details -->
                <div class="section" style="margin-bottom: var(--spacing-md);">
                    <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="layers"></i> Scenario Analysis</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md); line-height: 1.6;">
                        Detailed scenario breakdown showing probability-weighted outcomes across different Mars colonization timelines and growth rates.
                    </p>
                    <div class="scenarios-grid-compact" id="marsScenariosGridDetail" style="gap: var(--spacing-md);">
                        <!-- Detailed scenarios will be populated dynamically -->
                    </div>
                </div>
                </div>
            </div>

            <!-- Scenarios View -->
            <div id="scenarios" class="view">
                <div class="view-header">
                    <h2>Scenarios</h2>
                </div>

                <!-- Tabs for Scenario Analysis and Saved Scenarios -->
                <div class="models-tabs">
                    <button class="models-tab active" data-tab="scenario-analysis-tab" id="scenarioAnalysisTabBtn">
                        <i data-lucide="layers"></i>
                        Scenario Analysis
                    </button>
                    <button class="models-tab" data-tab="saved-scenarios-tab" id="savedScenariosTabBtn">
                        <i data-lucide="flask-conical"></i>
                        Saved Scenarios
                    </button>
                </div>

                <!-- Scenario Analysis Tab Content -->
                <div id="scenario-analysis-tab" class="models-tab-content active">
                    <div class="view-header" style="margin-top: 0;">
                        <h3>Scenario Analysis</h3>
                        <button class="btn btn-secondary btn-sm" id="runScenariosBtn">
                            <i data-lucide="refresh-cw"></i>
                            Recalculate
                        </button>
                    </div>

                    <!-- Multiple Scenario Comparison -->
                    <div class="section" style="margin-bottom: var(--spacing-md);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="margin: 0;"><i data-lucide="layers"></i> Scenario Comparison</h3>
                        </div>
                        <div class="scenarios-comparison-grid" id="scenariosComparisonGrid">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Scenario Distribution Comparison -->
                    <div class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="margin: 0;"><i data-lucide="trending-up"></i> Distribution Comparison</h3>
                            <button class="btn btn-secondary btn-sm" id="runScenarioMonteCarloBtn">
                                <i data-lucide="refresh-cw"></i>
                                Recalculate
                            </button>
                        </div>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="scenarioDistributionChart"></canvas>
                        </div>
                    </div>

                    <!-- Preset Scenarios -->
                    <div class="section">
                        <h3><i data-lucide="bookmark"></i> Preset Scenarios</h3>
                        <div class="scenarios-grid" id="scenariosGrid">
                            <!-- Scenarios will be loaded dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Saved Scenarios Tab Content -->
                <div id="saved-scenarios-tab" class="models-tab-content">
                    <div class="section">
                        <div class="models-toolbar">
                            <div class="models-toolbar-left">
                                <input type="text" id="scenarioSearch" placeholder="Search scenarios..." class="search-input">
                                <select id="scenarioSort" class="select-input">
                                    <option value="createdAt-desc">Newest First</option>
                                    <option value="createdAt-asc">Oldest First</option>
                                    <option value="name-asc">Name A-Z</option>
                                    <option value="name-desc">Name Z-A</option>
                                </select>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="showFavoritesOnlyScenarios">
                                    Favorites Only
                                </label>
                            </div>
                            <div class="models-toolbar-right">
                                <button class="btn btn-secondary btn-sm" id="addScenarioBtn">
                                    <i data-lucide="plus"></i>
                                    Add Scenario
                                </button>
                            </div>
                        </div>

                        <div class="models-grid" id="savedScenariosGrid">
                            <!-- Saved scenarios will be loaded dynamically -->
                        </div>

                        <div class="pagination" id="scenariosPagination">
                            <!-- Pagination will be added dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sensitivity View -->
            <div id="sensitivity" class="view">
                <div class="view-header">
                    <h2 style="display: flex; align-items: center; gap: var(--spacing-sm);">
                        Sensitivity Curves
                        <button class="icon-button" id="sensitivityInfoBtn" title="Sensitivity Curves Overview" style="margin-left: 4px;">
                            <i data-lucide="info"></i>
                        </button>
                    </h2>
                    <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                        <a href="#greeks" class="btn btn-secondary btn-sm" onclick="app.showView('greeks')" style="text-decoration: none;">
                            <i data-lucide="sigma"></i>
                            View Greeks
                        </a>
                        <button class="btn btn-secondary btn-sm" id="runSensitivityBtn">
                            <i data-lucide="refresh-cw"></i>
                            Recalculate
                        </button>
                    </div>
                </div>
                
                <!-- Sensitivity Info Modal -->
                <div id="sensitivityInfoModal" class="modal" style="display: none;" onclick="if(event.target.id === 'sensitivityInfoModal') app.closeSensitivityInfo()">
                    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2><i data-lucide="info"></i> Sensitivity Curves Overview</h2>
                            <button class="icon-button" onclick="app.closeSensitivityInfo()">
                                <i data-lucide="x"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="section">
                                <h3>Sensitivity Curves vs. Financial Greeks</h3>
                                <p class="info-text">
                                    <strong>Sensitivity Curves</strong> show how valuation changes across a full range of input values (e.g., "What happens if Starlink penetration goes from 10% to 20%?"). 
                                    <strong>Financial Greeks</strong> measure the instantaneous rate of change at the current point (e.g., "How sensitive is valuation to a 1% change right now?"). 
                                    Together, they provide both the full picture and point-in-time sensitivity.
                                </p>
                                
                                <h4 style="margin-top: 24px;">How Sensitivity Curves Work</h4>
                                <ul style="padding-left: 20px; line-height: 1.8;">
                                    <li><strong>Select a Variable:</strong> Choose any input parameter (e.g., Starlink penetration, discount rate)</li>
                                    <li><strong>Set a Range:</strong> Define the minimum and maximum values to test</li>
                                    <li><strong>Calculate Points:</strong> The system calculates valuation at multiple points across the range</li>
                                    <li><strong>Visualize:</strong> Results are displayed as a curve showing how valuation changes</li>
                                </ul>
                                
                                <h4 style="margin-top: 24px;">Key Insights</h4>
                                <ul style="padding-left: 20px; line-height: 1.8;">
                                    <li><strong>Linear vs. Non-Linear:</strong> Straight lines indicate linear relationships; curves show non-linear effects</li>
                                    <li><strong>Steepness:</strong> Steeper curves indicate higher sensitivity to that input</li>
                                    <li><strong>Inflection Points:</strong> Changes in curve direction reveal optimal ranges or thresholds</li>
                                    <li><strong>Comparison:</strong> Compare multiple variables to identify which inputs have the most impact</li>
                                </ul>
                                
                                <h4 style="margin-top: 24px;">Relationship to Financial Greeks</h4>
                                <p class="info-text" style="margin-top: var(--spacing-md);">
                                    Greeks are the mathematical derivatives of sensitivity curves: <strong>Delta = slope at current point</strong>, <strong>Gamma = curvature</strong>.
                                    Use sensitivity curves to see the full picture, then use Greeks to understand the exact sensitivity at your current point.
                                </p>
                                
                                <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border-color);">
                                    <a href="#greeks" onclick="app.showView('greeks'); app.closeSensitivityInfo();" style="color: var(--primary-color); text-decoration: underline; font-weight: 600;">
                                        View Financial Greeks →
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section" style="margin-bottom: var(--spacing-md);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                        <div class="form-group">
                            <label>Variable to Analyze</label>
                            <select id="sensitivityVariable" class="select-input">
                                <option value="earth.starlinkPenetration">Starlink Penetration</option>
                                <option value="earth.bandwidthPriceDecline">Bandwidth Price Decline</option>
                                <option value="earth.launchVolume">Launch Volume</option>
                                <option value="earth.launchPriceDecline">Launch Price Decline</option>
                                <option value="mars.firstColonyYear">First Colony Year</option>
                                <option value="mars.transportCostDecline">Transport Cost Decline</option>
                                <option value="mars.populationGrowth">Mars Population Growth</option>
                                <option value="financial.discountRate">Discount Rate</option>
                                <option value="financial.dilutionFactor">Dilution Factor</option>
                                <option value="financial.terminalGrowth">Terminal Growth Rate</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Range</label>
                            <div class="range-inputs">
                                <input type="number" id="sensitivityMin" placeholder="Min" step="0.01">
                                <input type="number" id="sensitivityMax" placeholder="Max" step="0.01">
                                <input type="number" id="sensitivitySteps" placeholder="Steps" value="20" step="1">
                            </div>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="sensitivityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Monte Carlo Simulation View -->
            <div id="monte-carlo" class="view">
                <div class="view-header">
                    <h2>Monte Carlo Simulation</h2>
                    <button class="btn btn-primary" id="runMonteCarloBtn">
                        <i data-lucide="dice-6"></i>
                        Rerun & Save Simulation
                    </button>
                </div>

                <!-- Monte Carlo Tabs -->
                <div class="insights-tabs" style="display: flex; gap: 8px; padding: 0 var(--spacing-lg); margin-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-color);">
                    <button class="insights-tab active" data-tab="dashboard">
                        <i data-lucide="layout-dashboard"></i>
                        <span>Dashboard</span>
                    </button>
                    <button class="insights-tab" data-tab="simulations">
                        <i data-lucide="table"></i>
                        <span>Simulations</span>
                    </button>
                    <button class="insights-tab" data-tab="parameters">
                        <i data-lucide="settings"></i>
                        <span>Parameters</span>
                    </button>
                </div>

                <!-- Dashboard Tab Content (Monte Carlo) -->
                <div id="modelsTab-dashboard" class="insights-tab-content active">
                    <!-- Results Section -->
                    <div id="monteCarloResultsSection" class="section" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3 style="margin: 0; font-size: 16px;"><i data-lucide="bar-chart"></i> Statistical Summary</h3>
                            <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                                <button class="icon-button" id="monteCarloInfoBtn" title="Monte Carlo Overview">
                                    <i data-lucide="info"></i>
                                </button>
                                <button class="btn btn-secondary btn-sm" id="saveMonteCarloBtn" onclick="app.saveMonteCarloSimulation()">
                                    <i data-lucide="save"></i> Save
                                </button>
                            </div>
                        </div>
                        
                        <div class="statistics-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                            <div class="stat-card" style="padding: 10px 12px;">
                                <h4 style="margin: 0 0 6px 0; font-size: 13px; color: var(--text-secondary);">Total Enterprise Value</h4>
                                <div style="display: grid; gap: 3px;">
                                    <div class="stat-row" style="display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 13px;">Mean:</span>
                                        <span id="mcMean" style="font-weight: 600; font-size: 13px;">--</span>
                                    </div>
                                    <div class="stat-row" style="display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 13px;">Median:</span>
                                        <span id="mcMedian" style="font-weight: 600; font-size: 13px;">--</span>
                                    </div>
                                    <div class="stat-row" style="display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 13px;">Std Dev:</span>
                                        <span id="mcStdDev" style="font-weight: 600; font-size: 13px;">--</span>
                                    </div>
                                    <div class="stat-row" style="display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 13px;">Min:</span>
                                        <span id="mcMin" style="font-weight: 600; font-size: 13px;">--</span>
                                    </div>
                                    <div class="stat-row" style="display: flex; justify-content: space-between; padding: 2px 0;">
                                        <span style="font-size: 13px;">Max:</span>
                                        <span id="mcMax" style="font-weight: 600; font-size: 13px;">--</span>
                                    </div>
                                </div>
                            </div>
                            <div class="stat-card" style="padding: 10px 12px;">
                                <h4 style="margin: 0 0 6px 0; font-size: 13px; color: var(--text-secondary);">Percentiles</h4>
                                <div style="display: grid; gap: 3px;">
                                    <div class="stat-row" style="display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 13px;">10th:</span>
                                        <span id="mcP10" style="font-weight: 600; font-size: 13px;">--</span>
                                    </div>
                                    <div class="stat-row" style="display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 13px;">25th (Q1):</span>
                                        <span id="mcQ1" style="font-weight: 600; font-size: 13px;">--</span>
                                    </div>
                                    <div class="stat-row" style="display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 13px;">75th (Q3):</span>
                                        <span id="mcQ3" style="font-weight: 600; font-size: 13px;">--</span>
                                    </div>
                                    <div class="stat-row" style="display: flex; justify-content: space-between; padding: 2px 0;">
                                        <span style="font-size: 13px;">90th:</span>
                                        <span id="mcP90" style="font-weight: 600; font-size: 13px;">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="chart-container" style="margin-bottom: var(--spacing-md);">
                            <canvas id="monteCarloDistributionChart"></canvas>
                        </div>

                        <div class="chart-container">
                            <canvas id="monteCarloComparisonChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="monteCarloEmptyState" class="section" style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">
                        <i data-lucide="dice-6" style="width: 48px; height: 48px; margin-bottom: var(--spacing-md); opacity: 0.5;"></i>
                        <p style="font-size: 16px; margin-bottom: var(--spacing-sm);">No simulation results yet</p>
                        <p style="font-size: 14px;">Click "Rerun & Save Simulation" to generate Monte Carlo results</p>
                    </div>
                </div>

                <!-- Parameters Tab Content -->
                <div id="insightsTab-parameters" class="insights-tab-content" style="display: none;">
                    <div class="section" id="monteCarloConfigSection">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3><i data-lucide="settings"></i> Configuration</h3>
                            <button class="btn btn-secondary btn-sm" id="editMonteCarloConfigBtn">
                                <i data-lucide="edit"></i> Edit
                            </button>
                        </div>
                        <div id="monteCarloConfigDisplay" class="config-display">
                            <div class="config-info">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md); margin-bottom: 16px;">
                                    <div style="background: var(--surface); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);">
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Number of Runs</div>
                                        <div style="font-size: 18px; font-weight: 600; color: var(--text-primary);" id="configRuns">5,000</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Simulation iterations</div>
                                    </div>
                                    <div style="background: var(--surface); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);">
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Distribution Type</div>
                                        <div style="font-size: 18px; font-weight: 600; color: var(--text-primary);" id="configDistributionType">Default</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Input variation method</div>
                                    </div>
                                    <div style="background: var(--surface); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);">
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Estimated Time</div>
                                        <div style="font-size: 18px; font-weight: 600; color: var(--text-primary);" id="configEstimatedTime">~5-10 sec</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">For 5,000 runs</div>
                                    </div>
                                </div>
                                <p id="configSource" style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">
                                    <i data-lucide="info"></i> Using default configuration. Click "Edit" to customize parameters.
                                </p>
                            </div>
                            
                            <div class="config-parameters" id="monteCarloParametersDisplay">
                                <h4 style="margin-top: 16px; margin-bottom: 12px;">Distribution Parameters</h4>
                                <div class="parameters-grid">
                                    <div class="parameter-group">
                                        <h5>Earth Parameters</h5>
                                        <div class="parameter-item">
                                            <span class="param-label">Starlink Penetration:</span>
                                            <span class="param-value">StdDev: <span id="paramEarthPenetrationStdDev">--</span>, Range: <span id="paramEarthPenetrationRange">--</span></span>
                                        </div>
                                        <div class="parameter-item">
                                            <span class="param-label">Launch Volume:</span>
                                            <span class="param-value">StdDev: <span id="paramEarthLaunchStdDev">--</span>, Range: <span id="paramEarthLaunchRange">--</span></span>
                                        </div>
                                        <div class="parameter-item">
                                            <span class="param-label">Bandwidth Price Decline:</span>
                                            <span class="param-value">StdDev: <span id="paramEarthBandwidthStdDev">--</span>, Range: <span id="paramEarthBandwidthRange">--</span></span>
                                        </div>
                                    </div>
                                    <div class="parameter-group">
                                        <h5>Mars Parameters</h5>
                                        <div class="parameter-item">
                                            <span class="param-label">First Colony Year:</span>
                                            <span class="param-value">StdDev: <span id="paramMarsColonyStdDev">--</span>, Range: <span id="paramMarsColonyRange">--</span></span>
                                        </div>
                                        <div class="parameter-item">
                                            <span class="param-label">Population Growth:</span>
                                            <span class="param-value">StdDev: <span id="paramMarsPopStdDev">--</span>, Range: <span id="paramMarsPopRange">--</span></span>
                                        </div>
                                    </div>
                                    <div class="parameter-group">
                                        <h5>Financial Parameters</h5>
                                        <div class="parameter-item">
                                            <span class="param-label">Discount Rate:</span>
                                            <span class="param-value">StdDev: <span id="paramFinancialDiscountStdDev">--</span>, Range: <span id="paramFinancialDiscountRange">--</span></span>
                                        </div>
                                        <div class="parameter-item">
                                            <span class="param-label">Dilution Factor:</span>
                                            <span class="param-value">StdDev: <span id="paramFinancialDilutionStdDev">--</span>, Range: <span id="paramFinancialDilutionRange">--</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Simulations Tab Content -->
                <div id="insightsTab-simulations" class="insights-tab-content" style="display: none;">
                    <div class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3><i data-lucide="table"></i> Simulation Results</h3>
                            <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                                <input type="text" id="simulationsSearch" placeholder="Search..." class="input-field" style="width: 200px;">
                                <select id="simulationsPageSize" class="input-field" style="width: 120px;">
                                    <option value="50">50 per page</option>
                                    <option value="100" selected>100 per page</option>
                                    <option value="250">250 per page</option>
                                    <option value="500">500 per page</option>
                                    <option value="1000">1000 per page</option>
                                </select>
                                <button class="btn btn-secondary btn-sm" id="exportSimulationsBtn">
                                    <i data-lucide="download"></i> Export CSV
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container" style="max-height: 70vh; overflow-y: auto;">
                            <table class="data-table" id="simulationsTable">
                                <thead style="position: sticky; top: 0; background: var(--surface); z-index: 10;">
                                    <tr>
                                        <th style="width: 60px;"></th>
                                        <th style="width: 80px;">Iteration</th>
                                        <!-- Key Inputs (most impactful) -->
                                        <th style="width: 130px;">Starlink Penetration</th>
                                        <th style="width: 120px;">Launch Volume</th>
                                        <th style="width: 130px;">First Colony Year</th>
                                        <th style="width: 130px;">Discount Rate</th>
                                        <!-- Final Valuations -->
                                        <th style="width: 140px;">Earth Value ($B)</th>
                                        <th style="width: 140px;">Mars Value ($B)</th>
                                        <th style="width: 150px;">Total Value ($B)</th>
                                        <th style="width: 140px;">Diluted Value ($B)</th>
                                        <!-- Percentages -->
                                        <th style="width: 100px;">Earth %</th>
                                        <th style="width: 100px;">Mars %</th>
                                        <!-- Actions -->
                                        <th style="width: 80px;">Details</th>
                                    </tr>
                                </thead>
                                <tbody id="simulationsTableBody">
                                    <tr>
                                        <td colspan="13" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">
                                            No simulation results available. Run a simulation to see results.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Monte Carlo Info Modal -->
                        <div id="monteCarloInfoModal" class="modal" style="display: none;" onclick="if(event.target.id === 'monteCarloInfoModal') app.closeMonteCarloInfo()">
                            <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                                <div class="modal-header">
                                    <h2><i data-lucide="info"></i> Monte Carlo Simulation Overview</h2>
                                    <button class="icon-button" onclick="app.closeMonteCarloInfo()">
                                        <i data-lucide="x"></i>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="section">
                                        <h3>What is Monte Carlo Simulation?</h3>
                                        <p class="info-text">Monte Carlo simulation runs thousands of simulations with random variations to generate statistical distributions and probability ranges for valuation outcomes.</p>
                                        
                                        <h4 style="margin-top: 24px;">How It Works</h4>
                                        <ol style="padding-left: 20px; line-height: 1.8;">
                                            <li><strong>Random Input Generation:</strong> Each simulation randomly varies inputs based on probability distributions</li>
                                            <li><strong>Valuation Calculation:</strong> For each set of random inputs, the model calculates Earth and Mars valuations</li>
                                            <li><strong>Statistical Analysis:</strong> After thousands of runs, the system calculates mean, median, percentiles, and standard deviation</li>
                                            <li><strong>Distribution Visualization:</strong> Results are displayed as histograms showing the probability distribution of outcomes</li>
                                        </ol>
                                        
                                        <h4 style="margin-top: 24px;">Key Benefits</h4>
                                        <ul style="padding-left: 20px; line-height: 1.8;">
                                            <li>Understand the <strong>range of possible outcomes</strong> rather than a single point estimate</li>
                                            <li>Identify <strong>tail risks</strong> and confidence intervals</li>
                                            <li>Quantify <strong>uncertainty</strong> in input assumptions</li>
                                            <li>Make more <strong>informed decisions</strong> based on probability distributions</li>
                                        </ul>
                                        
                                        <h4 style="margin-top: 24px;">Recommended Settings</h4>
                                        <ul style="padding-left: 20px; line-height: 1.8;">
                                            <li><strong>5,000 runs:</strong> Good balance between accuracy and speed (~5-10 seconds)</li>
                                            <li><strong>10,000+ runs:</strong> Higher precision for detailed analysis (slower)</li>
                                            <li><strong>Default distributions:</strong> Based on historical data and expert estimates</li>
                                            <li><strong>Custom distributions:</strong> Adjust based on your specific assumptions</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Detail Modal for expanded view -->
                        <div id="simulationDetailModal" class="modal" style="display: none;" onclick="if(event.target.id === 'simulationDetailModal') app.closeSimulationDetails()">
                            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                                <div class="modal-header">
                                    <h2>Simulation Details - Iteration <span id="detailIteration"></span></h2>
                                    <button class="icon-button" onclick="app.closeSimulationDetails()">
                                        <i data-lucide="x"></i>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div id="simulationDetailContent">
                                        <!-- Details will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pagination" id="simulationsPagination" style="margin-top: var(--spacing-md); display: flex; justify-content: center; align-items: center; gap: var(--spacing-sm);">
                            <!-- Pagination will be added dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stress Testing View -->
            <div id="stress" class="view">
                <div class="view-header">
                    <h2 style="display: flex; align-items: center; gap: var(--spacing-sm);">
                        Stress Testing & Failure Modes
                        <button class="icon-button" id="stressInfoBtn" title="Stress Testing Overview" style="margin-left: 4px;">
                            <i data-lucide="info"></i>
                        </button>
                    </h2>
                </div>

                <!-- Stress Testing Info Modal -->
                <div id="stressInfoModal" class="modal" style="display: none;" onclick="if(event.target.id === 'stressInfoModal') app.closeStressInfo()">
                    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2><i data-lucide="info"></i> Stress Testing Overview</h2>
                            <button class="icon-button" onclick="app.closeStressInfo()">
                                <i data-lucide="x"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="section">
                                <h3>What is Stress Testing?</h3>
                                <p class="info-text">Stress testing evaluates valuation under adverse conditions and failure modes. This analysis helps identify key risk factors and their impact on enterprise value.</p>
                                
                                <h4 style="margin-top: 24px;">How Stress Testing Works</h4>
                                <p class="info-text" style="margin-top: var(--spacing-md);">
                                    While Monte Carlo simulation explores the <strong>distribution of outcomes</strong> under normal uncertainty, stress testing evaluates <strong>specific adverse scenarios</strong> and failure modes. It answers: "What happens if things go wrong?"
                                </p>
                                
                                <h4 style="margin-top: 24px;">What Stress Testing Does</h4>
                                <ul style="padding-left: 20px; line-height: 1.8;">
                                    <li><strong>Tests extreme scenarios:</strong> Evaluates what happens under adverse conditions</li>
                                    <li><strong>Identifies failure modes:</strong> Reveals which assumptions, if violated, would most impact valuation</li>
                                    <li><strong>Quantifies downside risk:</strong> Shows how much value could be lost in worst-case scenarios</li>
                                    <li><strong>Validates model robustness:</strong> Ensures the valuation model behaves reasonably under stress</li>
                                </ul>
                                
                                <h4 style="margin-top: 24px;">Predefined Stress Scenarios</h4>
                                <p class="info-text" style="margin-top: var(--spacing-md);">
                                    The system includes predefined scenarios such as:
                                </p>
                                <ul style="padding-left: 20px; line-height: 1.8;">
                                    <li><strong>Mars Delay:</strong> Tests impact of delayed Mars colonization</li>
                                    <li><strong>Increased Competition:</strong> Evaluates effect of reduced market share</li>
                                    <li><strong>Regulatory Risk:</strong> Assesses impact of regulatory changes</li>
                                    <li><strong>Technology Failure:</strong> Tests resilience to technical setbacks</li>
                                </ul>
                                
                                <h4 style="margin-top: 24px;">Custom Stress Tests</h4>
                                <p class="info-text" style="margin-top: var(--spacing-md);">
                                    You can also create custom stress tests by modifying specific inputs and comparing the results to your base case. This allows you to test any scenario you can imagine.
                                </p>
                                
                                <h4 style="margin-top: 24px;">Key Insights</h4>
                                <ul style="padding-left: 20px; line-height: 1.8;">
                                    <li><strong>Risk Identification:</strong> Discover which inputs have the most impact when stressed</li>
                                    <li><strong>Valuation Resilience:</strong> Understand how robust your valuation is to adverse conditions</li>
                                    <li><strong>Scenario Planning:</strong> Prepare for different future outcomes</li>
                                    <li><strong>Decision Support:</strong> Make informed decisions about risk management and mitigation</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Predefined Stress Scenarios -->
                <div class="section">
                    <h3><i data-lucide="wind"></i> Predefined Stress Scenarios</h3>
                    <div class="stress-scenarios-grid" id="stressScenariosGrid">
                        <div class="stress-scenario-card" data-scenario="mars-delay">
                            <div class="stress-header">
                                <i data-lucide="clock"></i>
                                <h4>Mars Delay (30 years)</h4>
                            </div>
                            <p>First colony delayed to 2060</p>
                            <button class="btn btn-secondary btn-sm" onclick="app.runStressScenario('mars-delay')">
                                Run Test
                            </button>
                        </div>
                        <div class="stress-scenario-card" data-scenario="competition">
                            <div class="stress-header">
                                <i data-lucide="users"></i>
                                <h4>Increased Competition</h4>
                            </div>
                            <p>Starlink penetration reduced by 50%</p>
                            <button class="btn btn-secondary btn-sm" onclick="app.runStressScenario('competition')">
                                Run Test
                            </button>
                        </div>
                        <div class="stress-scenario-card" data-scenario="mars-failure">
                            <div class="stress-header">
                                <i data-lucide="x-circle"></i>
                                <h4>Mars Failure</h4>
                            </div>
                            <p>Mars operations fail completely</p>
                            <button class="btn btn-secondary btn-sm" onclick="app.runStressScenario('mars-failure')">
                                Run Test
                            </button>
                        </div>
                        <div class="stress-scenario-card" data-scenario="high-discount">
                            <div class="stress-header">
                                <i data-lucide="trending-down"></i>
                                <h4>High Discount Rate</h4>
                            </div>
                            <p>Discount rate increased to 20%</p>
                            <button class="btn btn-secondary btn-sm" onclick="app.runStressScenario('high-discount')">
                                Run Test
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stress Test Results -->
                <div class="section" id="stressResultsSection" style="display: none;">
                    <h3><i data-lucide="bar-chart"></i> Stress Test Results</h3>
                    <div class="stress-comparison">
                        <div class="comparison-card">
                            <h4>Base Case</h4>
                            <div class="comparison-value" id="stressBaseValue">$0.0B</div>
                        </div>
                        <div class="comparison-card stress">
                            <h4>Stress Scenario</h4>
                            <div class="comparison-value" id="stressScenarioValue">$0.0B</div>
                        </div>
                        <div class="comparison-card">
                            <h4>Impact</h4>
                            <div class="comparison-value" id="stressImpact">--</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="stressChart"></canvas>
                    </div>
                </div>

                <!-- Custom Stress Test -->
                <div class="section">
                    <h3><i data-lucide="sliders"></i> Custom Stress Test</h3>
                    <div class="form-group">
                        <label>Scenario Name</label>
                        <input type="text" id="customStressName" placeholder="e.g., Regulatory Risk" class="input-full">
                    </div>
                    <div class="stress-inputs-grid">
                        <div class="input-section-small">
                            <h4>Earth Modifications</h4>
                            <div class="form-group">
                                <label>Starlink Penetration Multiplier</label>
                                <input type="number" id="stressStarlinkMult" value="1.0" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Launch Volume Multiplier</label>
                                <input type="number" id="stressLaunchMult" value="1.0" step="0.1" min="0">
                            </div>
                        </div>
                        <div class="input-section-small">
                            <h4>Mars Modifications</h4>
                            <div class="form-group">
                                <label>Colony Year Offset</label>
                                <input type="number" id="stressColonyOffset" value="0" step="1">
                            </div>
                            <div class="form-group">
                                <label>Population Growth Multiplier</label>
                                <input type="number" id="stressPopGrowthMult" value="1.0" step="0.1" min="0">
                            </div>
                        </div>
                        <div class="input-section-small">
                            <h4>Financial Modifications</h4>
                            <div class="form-group">
                                <label>Discount Rate Adjustment</label>
                                <input type="number" id="stressDiscountAdj" value="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Dilution Adjustment</label>
                                <input type="number" id="stressDilutionAdj" value="0" step="0.01">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="runCustomStressBtn">
                        <i data-lucide="play"></i>
                        Run Custom Stress Test
                    </button>
                </div>
            </div>

            <!-- Insights View -->
            <div id="insights" class="view">
                <!-- Insights Tabs -->
                <div class="insights-tabs" style="display: flex; gap: 8px; padding: 0 var(--spacing-lg); margin-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-color); align-items: center;">
                    <span style="display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: 600; color: var(--text-primary); margin-right: var(--spacing-md);">
                        <i data-lucide="lightbulb" style="width: 18px; height: 18px;"></i>
                        <span>Insights</span>
                    </span>
                    <button class="insights-tab active" data-tab="dashboard">
                        <i data-lucide="terminal"></i>
                        <span>Mach33 Terminal</span>
                    </button>
                    <button class="insights-tab" data-tab="drivers">
                        <i data-lucide="trending-up"></i>
                        <span>Value Drivers</span>
                    </button>
                    <button class="insights-tab" data-tab="risks">
                        <i data-lucide="alert-triangle"></i>
                        <span>Risk Assessment</span>
                    </button>
                    <button class="insights-tab" data-tab="real-time">
                        <i data-lucide="activity"></i>
                        <span>Real-Time Data</span>
                    </button>
                    <div style="flex: 1;"></div>
                    <label class="toggle-switch" title="Bloomberg Dense Mode" style="display: flex; align-items: center; gap: 6px; cursor: pointer; opacity: 0.7; font-size: 11px; color: var(--text-secondary);">
                        <input type="checkbox" id="bloombergDenseToggle" style="display: none;">
                        <span class="toggle-slider"></span>
                        <span>Dense</span>
                    </label>
                    <button class="icon-button" id="refreshInsightsHeaderBtn" title="Refresh AI Insights" style="padding: 4px; opacity: 0.6; transition: opacity 0.2s;">
                        <i data-lucide="refresh-cw" id="refreshInsightsIcon" style="width: 16px; height: 16px; transition: transform 0.3s;"></i>
                    </button>
                </div>

                <!-- Tab Content -->

                <div class="insights-tab-content" id="insightsTab-drivers">
                    <div class="section" style="margin-bottom: var(--spacing-md);">
                        <div id="valueDriversContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md);">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>

                <div class="insights-tab-content" id="insightsTab-risks">
                    <div class="section" style="margin-bottom: var(--spacing-md);">
                        <div id="riskAssessmentContent">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>

                <div class="insights-tab-content" id="insightsTab-real-time">
                    <!-- Launch Statistics Tiles -->
                    <div class="section" style="margin-bottom: var(--spacing-md);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="margin: 0; font-size: 16px;"><i data-lucide="activity"></i> Real-Time Launch Data</h3>
                            <button class="btn btn-secondary btn-sm" id="refreshLaunchDataBtn" onclick="app.refreshLaunchData()">
                                <i data-lucide="refresh-cw"></i> Refresh
                            </button>
                        </div>
                        <div id="launchDataTiles" class="insight-tiles-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--spacing-md);">
                            <div class="loading-state">Loading launch data...</div>
                        </div>
                    </div>

                    <!-- Upcoming Launches -->
                    <div class="section" style="margin-bottom: var(--spacing-md);">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="calendar"></i> Upcoming Launches</h3>
                        <div id="upcomingLaunchesList" style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                            <div class="loading-state">Loading upcoming launches...</div>
                        </div>
                    </div>

                    <!-- Recent Launches Timeline -->
                    <div class="section" style="margin-bottom: var(--spacing-md);">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="clock"></i> Recent Launches</h3>
                        <div id="recentLaunchesList" style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                            <div class="loading-state">Loading recent launches...</div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Tab Content (New Bloomberg Terminal Style) -->
                <div class="insights-tab-content active" id="insightsTab-dashboard" style="display: flex; flex-direction: column; height: calc(100vh - 200px);">
                    <!-- Dashboard Container -->
                    <div class="section" style="flex: 1; display: flex; flex-direction: column; margin-bottom: var(--spacing-md); min-height: 0;">
                        <!-- 4x4 Grid Container -->
                        <div id="dashboardGrid" class="dashboard-grid" style="
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            grid-template-rows: repeat(4, 1fr);
                            gap: var(--spacing-sm);
                            width: 100%;
                            max-width: 1400px;
                            margin: 0 auto;
                            flex: 1;
                            min-height: 600px;
                        ">
                            <!-- Tiles will be dynamically inserted here -->
                            <div style="grid-column: 1 / -1; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); padding: var(--spacing-xl);">
                                <div style="text-align: center;">
                                    <i data-lucide="loader" class="spinning" style="width: 32px; height: 32px; margin: 0 auto 16px; display: block;"></i>
                                    <p>Generating dashboard layout...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts View -->
            <div id="charts" class="view">
                <div class="view-header">
                    <div>
                        <h2>Canonical Charts</h2>
                        <div style="font-size: 14px; color: var(--text-secondary); margin-top: 4px;" id="chartsModelName">
                            <span id="chartsCurrentModel">No model loaded</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Tabs -->
                <div class="insights-tabs" style="display: flex; gap: 8px; padding: 0 var(--spacing-lg); margin-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-color);">
                    <button class="insights-tab active" data-tab="cashFlywheel">
                        <i data-lucide="trending-up"></i>
                        <span>Cash Flywheel</span>
                    </button>
                    <button class="insights-tab" data-tab="marsCapital">
                        <i data-lucide="layers"></i>
                        <span>Mars Capital</span>
                    </button>
                    <button class="insights-tab" data-tab="enterpriseValue">
                        <i data-lucide="chart-bar"></i>
                        <span>Value Evolution</span>
                    </button>
                    <button class="insights-tab" data-tab="starshipCost">
                        <i data-lucide="dollar-sign"></i>
                        <span>Starship Economics</span>
                    </button>
                    <button class="insights-tab" data-tab="orbitalPower">
                        <i data-lucide="zap"></i>
                        <span>Orbital Power</span>
                    </button>
                    <button class="insights-tab" data-tab="marginEvolution">
                        <i data-lucide="percent"></i>
                        <span>Margin Evolution</span>
                    </button>
                    <button class="insights-tab" data-tab="unitEconomics">
                        <i data-lucide="target"></i>
                        <span>Unit Economics</span>
                    </button>
                    <button class="insights-tab" data-tab="capexEfficiency">
                        <i data-lucide="trending-down"></i>
                        <span>Capex Efficiency</span>
                    </button>
                </div>

                <!-- Chart Tab Content -->
                <div class="insights-tab-content active" id="insightsTab-cashFlywheel">
                    <div class="section" style="margin-bottom: var(--spacing-md);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="margin: 0; font-size: 16px;"><i data-lucide="trending-up"></i> Starlink Cash Flywheel</h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="insight-scenario-btn" data-chart="cashFlywheel" data-scenario="bear" style="background: #2a2a2a; color: #888; border: 1px solid #444; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Bear</button>
                                <button class="insight-scenario-btn active" data-chart="cashFlywheel" data-scenario="base" style="background: white; color: #0066cc; border: 1px solid #0066cc; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500;">Base</button>
                                <button class="insight-scenario-btn" data-chart="cashFlywheel" data-scenario="bull" style="background: #2a2a2a; color: #888; border: 1px solid #444; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Bull</button>
                            </div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md); line-height: 1.6;">
                            Projected Starlink revenue and free cash flow rise exponentially through the decade while cost lines stay comparatively flat, widening profit margins year after year.
                        </p>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="cashFlywheelChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="insights-tab-content" id="insightsTab-marsCapital">
                    <div class="section" style="margin-bottom: var(--spacing-md);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="margin: 0; font-size: 16px;"><i data-lucide="layers"></i> Mars Capital Accumulation</h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="insight-scenario-btn" data-chart="marsCapital" data-scenario="bear" style="background: #2a2a2a; color: #888; border: 1px solid #444; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Bear</button>
                                <button class="insight-scenario-btn active" data-chart="marsCapital" data-scenario="base" style="background: white; color: #0066cc; border: 1px solid #0066cc; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500;">Base</button>
                                <button class="insight-scenario-btn" data-chart="marsCapital" data-scenario="bull" style="background: #2a2a2a; color: #888; border: 1px solid #444; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Bull</button>
                            </div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md); line-height: 1.6;">
                            Mars Accumulated Book Value represents the running total of value built up on Mars through cargo and Optimus robot deployments. The Optimus Fleet curve shows the cumulative number of productive units on Mars.
                        </p>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="marsCapitalChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="insights-tab-content" id="insightsTab-enterpriseValue">
                    <div class="section" style="margin-bottom: var(--spacing-md);">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="chart-bar"></i> Enterprise Value Evolution</h3>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md); line-height: 1.6;">
                            The Monte Carlo output shows a narrow low-trillion peak for 2030 and a much wider, high-upside tail for 2040, reflecting the transition from Earth cash-flow dominance to Mars optionality.
                        </p>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="enterpriseValueEvolutionChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="insights-tab-content" id="insightsTab-starshipCost">
                    <div class="section" style="margin-bottom: var(--spacing-md);">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="dollar-sign"></i> Starship $/kg at Industrial Scale</h3>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md); line-height: 1.6;">
                            Cost per kilogram declines dramatically with production scale and reuse, showing how Starship shifts from an exotic rocket into foundational logistics infrastructure. Wright's Law models cost decline as production scales.
                        </p>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="starshipCostChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="insights-tab-content" id="insightsTab-orbitalPower">
                    <div class="section" style="margin-bottom: var(--spacing-md);">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="zap"></i> $/W in Orbit vs. HEO $/kg</h3>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md); line-height: 1.6;">
                            As launch costs decrease, orbital power generation becomes increasingly competitive with terrestrial solar. The chart shows crossover points where HEO technologies become cost-effective alternatives to ground-based power systems.
                        </p>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="orbitalPowerChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="insights-tab-content" id="insightsTab-marginEvolution">
                    <div class="section" style="margin-bottom: var(--spacing-md);">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="percent"></i> Margin Evolution</h3>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md); line-height: 1.6;">
                            Operating leverage drives margin expansion as revenue scales faster than costs. EBITDA margin and Free Cash Flow margin show the progression from capital-intensive growth to cash-generating operations.
                        </p>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="marginEvolutionChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="insights-tab-content" id="insightsTab-unitEconomics">
                    <div class="section" style="margin-bottom: var(--spacing-md);">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="target"></i> Unit Economics</h3>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md); line-height: 1.6;">
                            Unit economics reveal operational efficiency trends. Revenue per satellite, revenue per Gbps, and cost per launch demonstrate how scale drives profitability improvements.
                        </p>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="unitEconomicsChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="insights-tab-content" id="insightsTab-capexEfficiency">
                    <div class="section" style="margin-bottom: var(--spacing-md);">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px;"><i data-lucide="trending-down"></i> Capex Efficiency</h3>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md); line-height: 1.6;">
                            Capital efficiency improves as infrastructure matures. Capex as a percentage of revenue declines while reinvestment rates stabilize, indicating transition from growth to cash generation phase.
                        </p>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="capexEfficiencyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Greeks View -->
            <div id="greeks" class="view">
                <div class="view-header">
                    <h2>Financial Greeks</h2>
                    <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                        <a href="#sensitivity" class="btn btn-secondary btn-sm" onclick="app.showView('sensitivity')" style="text-decoration: none;">
                            <i data-lucide="trending-up"></i>
                            View Sensitivity Curves
                        </a>
                        <button class="btn btn-primary" id="calculateGreeksBtn">
                            <i data-lucide="sigma"></i>
                            Calculate Greeks
                        </button>
                    </div>
                </div>

                <!-- Greeks Dashboard -->
                <div class="section" id="greeksDashboard" style="display: none; position: relative;">
                    <div id="greeksMethodIndicator" style="position: absolute; top: 10px; right: 50px; font-size: 11px; color: var(--text-secondary); background: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 4px; display: none;">
                        Method: <span id="greeksMethodDisplay">-</span>
                    </div>
                    <button class="ai-explanation-icon" onclick="app.showAIExplanation('greeksDashboard', event)" title="AI Analysis">
                        <i data-lucide="sparkles"></i>
                    </button>
                    <h3 style="display: flex; align-items: center; gap: var(--spacing-sm);">
                        <i data-lucide="bar-chart-3"></i> Greeks Dashboard
                        <button class="info-icon-button" onclick="app.toggleInfoPanel('greeksOverview')" title="Financial Greeks Overview">
                            <i data-lucide="info"></i>
                        </button>
                    </h3>
                    
                    <!-- Summary Cards -->
                    <div class="metrics-grid" style="margin-bottom: var(--spacing-lg);">
                        <div class="metric-card-small" style="position: relative;">
                            <button class="ai-explanation-icon" onclick="app.showMicroAI('delta', event)" title="AI Explanation">
                                <i data-lucide="sparkles"></i>
                            </button>
                            <div class="metric-label-small" style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.8em; font-weight: 600; line-height: 1; position: relative; color: var(--primary-color);">
                                    Δ<sub style="font-size: 0.5em; position: absolute; bottom: -2px; right: -6px;">f</sub>
                                </span>
                                <span>Total Delta</span>
                            </div>
                            <div class="metric-value-small" id="totalDelta">--</div>
                            <div class="ai-explanation-popup" id="microAI-delta" style="display: none;">
                                <div class="ai-explanation-popup-content" id="microAI-delta-content">
                                    <i data-lucide="loader" class="spinning"></i> Loading...
                                </div>
                            </div>
                        </div>
                        <div class="metric-card-small" style="position: relative;">
                            <button class="ai-explanation-icon" onclick="app.showMicroAI('gamma', event)" title="AI Explanation">
                                <i data-lucide="sparkles"></i>
                            </button>
                            <div class="metric-label-small" style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.8em; font-weight: 600; line-height: 1; position: relative; color: var(--primary-color);">
                                    Γ<sub style="font-size: 0.5em; position: absolute; bottom: -2px; right: -6px;">f</sub>
                                </span>
                                <span>Total Gamma</span>
                            </div>
                            <div class="metric-value-small" id="totalGamma">--</div>
                            <div class="ai-explanation-popup" id="microAI-gamma" style="display: none;">
                                <div class="ai-explanation-popup-content" id="microAI-gamma-content">
                                    <i data-lucide="loader" class="spinning"></i> Loading...
                                </div>
                            </div>
                        </div>
                        <div class="metric-card-small" style="position: relative;">
                            <button class="ai-explanation-icon" onclick="app.showMicroAI('vega', event)" title="AI Explanation">
                                <i data-lucide="sparkles"></i>
                            </button>
                            <div class="metric-label-small" style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.8em; font-weight: 600; line-height: 1; position: relative; color: var(--primary-color);">
                                    ν<sub style="font-size: 0.5em; position: absolute; bottom: -2px; right: -6px;">f</sub>
                                </span>
                                <span>Total Vega</span>
                            </div>
                            <div class="metric-value-small" id="totalVega">--</div>
                            <div class="ai-explanation-popup" id="microAI-vega" style="display: none;">
                                <div class="ai-explanation-popup-content" id="microAI-vega-content">
                                    <i data-lucide="loader" class="spinning"></i> Loading...
                                </div>
                            </div>
                        </div>
                        <div class="metric-card-small" style="position: relative;">
                            <button class="ai-explanation-icon" onclick="app.showMicroAI('theta', event)" title="AI Explanation">
                                <i data-lucide="sparkles"></i>
                            </button>
                            <div class="metric-label-small" style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.8em; font-weight: 600; line-height: 1; position: relative; color: var(--primary-color);">
                                    Θ<sub style="font-size: 0.5em; position: absolute; bottom: -2px; right: -6px;">f</sub>
                                </span>
                                <span>Total Theta</span>
                            </div>
                            <div class="metric-value-small" id="totalTheta">--</div>
                            <div class="ai-explanation-popup" id="microAI-theta" style="display: none;">
                                <div class="ai-explanation-popup-content" id="microAI-theta-content">
                                    <i data-lucide="loader" class="spinning"></i> Loading...
                                </div>
                            </div>
                        </div>
                        <div class="metric-card-small" style="position: relative;">
                            <button class="ai-explanation-icon" onclick="app.showMicroAI('rho', event)" title="AI Explanation">
                                <i data-lucide="sparkles"></i>
                            </button>
                            <div class="metric-label-small" style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.8em; font-weight: 600; line-height: 1; position: relative; color: var(--primary-color);">
                                    ρ<sub style="font-size: 0.5em; position: absolute; bottom: -2px; right: -6px;">f</sub>
                                </span>
                                <span>Total Rho</span>
                            </div>
                            <div class="metric-value-small" id="totalRho">--</div>
                            <div class="ai-explanation-popup" id="microAI-rho" style="display: none;">
                                <div class="ai-explanation-popup-content" id="microAI-rho-content">
                                    <i data-lucide="loader" class="spinning"></i> Loading...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Delta Heatmap -->
                    <div class="chart-container-half" style="position: relative;">
                        <button class="ai-explanation-icon" onclick="app.showChartAIExplanation('deltaHeatmap', event)" title="AI Explanation">
                            <i data-lucide="sparkles"></i>
                        </button>
                        <h3>Delta Heatmap</h3>
                        <canvas id="deltaHeatmapChart"></canvas>
                        <div class="ai-explanation-popup" id="aiExplanation-deltaHeatmap" style="display: none;">
                            <div class="ai-explanation-popup-content" id="aiExplanation-deltaHeatmap-content">
                                <i data-lucide="loader" class="spinning"></i> Loading...
                            </div>
                        </div>
                    </div>

                    <!-- Component Breakdown -->
                    <div class="charts-row" style="margin-top: var(--spacing-lg);">
                        <div class="chart-container-half" style="position: relative;">
                            <button class="ai-explanation-icon" onclick="app.showChartAIExplanation('earthGreeks', event)" title="AI Explanation">
                                <i data-lucide="sparkles"></i>
                            </button>
                            <h3>Earth Greeks</h3>
                            <canvas id="earthGreeksChart"></canvas>
                            <div class="ai-explanation-popup" id="aiExplanation-earthGreeks" style="display: none;">
                                <div class="ai-explanation-popup-content" id="aiExplanation-earthGreeks-content">
                                    <i data-lucide="loader" class="spinning"></i> Loading...
                                </div>
                            </div>
                        </div>
                        <div class="chart-container-half" style="position: relative;">
                            <button class="ai-explanation-icon" onclick="app.showChartAIExplanation('marsGreeks', event)" title="AI Explanation">
                                <i data-lucide="sparkles"></i>
                            </button>
                            <h3>Mars Greeks</h3>
                            <canvas id="marsGreeksChart"></canvas>
                            <div class="ai-explanation-popup" id="aiExplanation-marsGreeks" style="display: none;">
                                <div class="ai-explanation-popup-content" id="aiExplanation-marsGreeks-content">
                                    <i data-lucide="loader" class="spinning"></i> Loading...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Combined Risk View -->
                    <div class="section" style="margin-top: var(--spacing-lg); background: rgba(0, 102, 204, 0.03); border-left: 3px solid var(--primary-color); padding: var(--spacing-md);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                            <h3 style="margin: 0;"><i data-lucide="layers"></i> Combined Risk Analysis</h3>
                            <a href="#factor-risk" class="btn btn-secondary btn-sm" onclick="app.showView('factor-risk')" style="text-decoration: none;">
                                <i data-lucide="bar-chart-3"></i>
                                View Factor Risk
                            </a>
                        </div>
                        <div id="combinedRiskView" style="display: none;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md);">
                                <div class="metric-card-small">
                                    <div class="metric-label-small">Greeks Risk</div>
                                    <div class="metric-value-small" id="greeksRiskTotal">--</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Model input sensitivity</div>
                                </div>
                                <div class="metric-card-small">
                                    <div class="metric-label-small">Factor Risk</div>
                                    <div class="metric-value-small" id="factorRiskTotal">--</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Market factor exposure</div>
                                </div>
                                <div class="metric-card-small">
                                    <div class="metric-label-small">Total Risk</div>
                                    <div class="metric-value-small" id="totalCombinedRisk">--</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Combined risk estimate</div>
                                </div>
                            </div>
                            <div style="margin-top: var(--spacing-md);">
                                <canvas id="combinedRiskChart"></canvas>
                            </div>
                        </div>
                        <div id="combinedRiskPlaceholder" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">
                            <p style="margin: 0;">Calculate both Greeks and Factor Risk to see combined analysis</p>
                        </div>
                    </div>

                    <!-- Detailed Tables -->
                    <div class="section" style="margin-top: var(--spacing-lg);">
                        <h3><i data-lucide="table"></i> Detailed Greeks Values</h3>
                        
                        <div class="charts-row">
                            <div class="section" style="margin: 0;">
                                <h4>Earth Component</h4>
                                <div class="table-container">
                                    <table class="data-table" id="earthGreeksTable">
                                        <thead>
                                            <tr>
                                                <th>Input</th>
                                                <th>Delta ($B/unit)</th>
                                                <th>Gamma</th>
                                                <th>Vega</th>
                                                <th>Rho</th>
                                            </tr>
                                        </thead>
                                        <tbody id="earthGreeksTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="section" style="margin: 0;">
                                <h4>Mars Component</h4>
                                <div class="table-container">
                                    <table class="data-table" id="marsGreeksTable">
                                        <thead>
                                            <tr>
                                                <th>Input</th>
                                                <th>Delta ($B/unit)</th>
                                                <th>Gamma</th>
                                                <th>Vega</th>
                                                <th>Theta</th>
                                                <th>Rho</th>
                                            </tr>
                                        </thead>
                                        <tbody id="marsGreeksTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Factor Risk View -->
            <div id="factor-risk" class="view">
                <div class="view-header">
                    <h2>Factor Risk Analysis</h2>
                    <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                        <a href="#greeks" class="btn btn-secondary btn-sm" onclick="app.showView('greeks')" style="text-decoration: none;">
                            <i data-lucide="sigma"></i>
                            View Greeks
                        </a>
                        <select id="factorModelSelect" class="input-field" style="min-width: 200px;">
                            <option value="fama-french-3">Fama-French 3-Factor</option>
                            <option value="fama-french-5">Fama-French 5-Factor</option>
                            <option value="barra-style" selected>Barra-Style Multi-Factor</option>
                            <option value="custom">Custom Model</option>
                        </select>
                        <button class="btn btn-primary" id="calculateFactorRiskBtn">
                            <i data-lucide="bar-chart-3"></i>
                            Calculate Factor Risk
                        </button>
                    </div>
                </div>

                <!-- Factor Risk Info Icon -->
                <div id="factorRiskInfoIconContainer" style="position: relative; display: inline-block; margin-bottom: var(--spacing-md);">
                    <button class="icon-button" onclick="app.showFactorRiskInfo(event)" title="Factor Risk Explained" style="position: relative;">
                        <i data-lucide="info"></i>
                    </button>
                </div>

                <!-- Factor Risk Info Floating Panel -->
                <div id="factorRiskInfoPanel" class="floating-panel" style="display: none;">
                    <div class="floating-panel-content">
                        <div class="floating-panel-header">
                            <h3 style="margin: 0; display: flex; align-items: center; gap: var(--spacing-sm);">
                                <i data-lucide="info"></i> Factor Risk Explained
                            </h3>
                            <button class="icon-button" onclick="app.closeFactorRiskInfo()" style="padding: 4px;">
                                <i data-lucide="x"></i>
                            </button>
                        </div>
                        <div class="floating-panel-body">
                            <p class="info-text" style="margin-bottom: var(--spacing-md);">
                                <strong>Factor Risk</strong> measures how SpaceX valuation correlates with market/systematic factors (what you can't control), 
                                while <strong>Greeks</strong> measure sensitivity to model inputs (what you can control).
                            </p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-md); margin-top: var(--spacing-md);">
                                <div>
                                    <strong>Greeks (Model Inputs)</strong>: "What if Starlink penetration changes?"<br>
                                    <em>Example:</em> Delta = $50B per 1% increase in penetration
                                </div>
                                <div>
                                    <strong>Factors (Market)</strong>: "What if tech sector crashes?"<br>
                                    <em>Example:</em> Tech Growth Factor exposure = 0.75 beta → 20% crash = -$120B
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Factor Risk Dashboard -->
                <div class="section" id="factorRiskDashboard" style="display: none;">
                    <h3><i data-lucide="bar-chart-3"></i> Factor Exposure Dashboard</h3>
                    
                    <!-- Model Info -->
                    <div id="factorModelInfo" style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: var(--surface); border-radius: var(--radius);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 4px 0;" id="factorModelName">--</h4>
                                <p style="margin: 0; font-size: 13px; color: var(--text-secondary);" id="factorModelDescription">--</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: var(--text-secondary);">Total Factor Risk</div>
                                <div style="font-size: 24px; font-weight: 600;" id="totalFactorRisk">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- Factor Tiles -->
                    <div class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                            <h4 style="margin: 0;">Factor Exposures</h4>
                            <button class="btn btn-secondary btn-sm" onclick="app.showFactorChart()" id="showChartsBtn" style="display: none;">
                                <i data-lucide="bar-chart-3"></i>
                                View Charts
                            </button>
                        </div>
                        <div id="factorTilesContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: var(--spacing-sm);">
                            <!-- Factor tiles will be populated here -->
                        </div>
                    </div>

                    <!-- Factor Charts Modal -->
                    <div id="factorChartsModal" class="modal" style="display: none;" onclick="if(event.target.id === 'factorChartsModal') app.closeFactorChartsModal()">
                        <div class="modal-content modal-large" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h2><i data-lucide="bar-chart-3"></i> Factor Charts</h2>
                                <button class="modal-close" onclick="app.closeFactorChartsModal()">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="charts-row">
                                    <div class="chart-container-half">
                                        <h4>Factor Risk Contribution</h4>
                                        <canvas id="factorRiskChart"></canvas>
                                    </div>
                                    <div class="chart-container-half">
                                        <h4>Factor Exposure Comparison</h4>
                                        <canvas id="factorExposureChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stress Testing -->
                    <div class="section" style="margin-top: var(--spacing-lg);">
                        <h4><i data-lucide="alert-triangle"></i> Factor Stress Testing</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-md);">
                            <div>
                                <label class="input-label">Factor</label>
                                <select id="stressTestFactor" class="input-field">
                                    <option value="">Select factor...</option>
                                </select>
                            </div>
                            <div>
                                <label class="input-label">Shock (%)</label>
                                <input type="number" id="stressTestShock" class="input-field" step="0.01" value="-0.20" placeholder="-0.20">
                            </div>
                            <div style="display: flex; align-items: flex-end;">
                                <button class="btn btn-secondary" id="runStressTestBtn">
                                    <i data-lucide="zap"></i>
                                    Run Stress Test
                                </button>
                            </div>
                        </div>
                        <div id="stressTestResults" style="margin-top: var(--spacing-md); display: none;">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- PnL Attribution View -->
            <div id="attribution" class="view">
                <div class="view-header">
                    <h2 style="display: flex; align-items: center; gap: var(--spacing-sm);">
                        PnL Attribution
                        <button class="icon-button" id="attributionInfoBtn" title="PnL Attribution Overview" style="margin-left: 4px;">
                            <i data-lucide="info"></i>
                        </button>
                    </h2>
                    <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                        <a href="#greeks" class="btn btn-secondary btn-sm" onclick="app.showView('greeks')" style="text-decoration: none;">
                            <i data-lucide="sigma"></i>
                            View Greeks
                        </a>
                        <select id="attributionBaseModel" class="input-field" style="min-width: 180px;">
                            <option value="">Current Model</option>
                        </select>
                        <select id="attributionCompareModel" class="input-field" style="min-width: 180px;">
                            <option value="">Select model...</option>
                        </select>
                        <button class="btn btn-primary" id="calculateAttributionBtn">
                            <i data-lucide="pie-chart"></i>
                            Calculate Attribution
                        </button>
                    </div>
                </div>

                <!-- PnL Attribution Info Modal -->
                <div id="attributionInfoModal" class="modal" style="display: none;" onclick="if(event.target.id === 'attributionInfoModal') app.closeAttributionInfo()">
                    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2><i data-lucide="info"></i> PnL Attribution Overview</h2>
                            <button class="icon-button" onclick="app.closeAttributionInfo()">
                                <i data-lucide="x"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="section">
                                <h3>What is PnL Attribution?</h3>
                                <p class="info-text">
                                    <strong>PnL Attribution</strong> uses Financial Greeks to explain <em>why</em> valuation changed. It decomposes valuation movements into contributions from each input, allowing you to understand exactly what drove the change.
                                </p>
                                
                                <h4 style="margin-top: 24px;">How PnL Attribution Works</h4>
                                <p class="info-text" style="margin-top: var(--spacing-md);">
                                    When comparing two scenarios or models, PnL Attribution breaks down the total valuation change into contributions from each Greek:
                                </p>
                                
                                <div style="display: grid; grid-template-columns: 1fr; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                                    <div style="padding: var(--spacing-md); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border-color);">
                                        <strong>Delta Attribution</strong>
                                        <p style="margin: var(--spacing-sm) 0 0 0; font-size: 14px; color: var(--text-secondary);">
                                            <strong>Formula:</strong> ΔValue = Delta × ΔInput<br>
                                            <em>Example:</em> If Starlink penetration increases by 2% and Delta = $45B/%, then Delta PnL = $90B
                                        </p>
                                    </div>
                                    <div style="padding: var(--spacing-md); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border-color);">
                                        <strong>Gamma Attribution</strong>
                                        <p style="margin: var(--spacing-sm) 0 0 0; font-size: 14px; color: var(--text-secondary);">
                                            <strong>Formula:</strong> ΔValue = 0.5 × Gamma × (ΔInput)²<br>
                                            <em>Example:</em> Captures non-linear/convexity effects when inputs change significantly
                                        </p>
                                    </div>
                                    <div style="padding: var(--spacing-md); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border-color);">
                                        <strong>Vega Attribution</strong>
                                        <p style="margin: var(--spacing-sm) 0 0 0; font-size: 14px; color: var(--text-secondary);">
                                            <strong>Formula:</strong> ΔValue = Vega × ΔVolatility<br>
                                            <em>Example:</em> If uncertainty increases by 5% and Vega = $200B/%, then Vega PnL = $1T
                                        </p>
                                    </div>
                                    <div style="padding: var(--spacing-md); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border-color);">
                                        <strong>Theta Attribution</strong>
                                        <p style="margin: var(--spacing-sm) 0 0 0; font-size: 14px; color: var(--text-secondary);">
                                            <strong>Formula:</strong> ΔValue = Theta × ΔTime<br>
                                            <em>Example:</em> Time decay for Mars option as colony date approaches
                                        </p>
                                    </div>
                                    <div style="padding: var(--spacing-md); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border-color);">
                                        <strong>Rho Attribution</strong>
                                        <p style="margin: var(--spacing-sm) 0 0 0; font-size: 14px; color: var(--text-secondary);">
                                            <strong>Formula:</strong> ΔValue = Rho × ΔDiscountRate<br>
                                            <em>Example:</em> If discount rate increases by 1% and Rho = -$35B/%, then Rho PnL = -$35B
                                        </p>
                                    </div>
                                </div>
                                
                                <h4 style="margin-top: 24px;">Total PnL Calculation</h4>
                                <p class="info-text" style="margin-top: var(--spacing-md);">
                                    <strong>Total PnL</strong> = Sum of all Greek contributions. This allows you to answer: "Why did valuation change from $4.5T to $4.8T?" by attributing the $300B change to specific input movements.
                                </p>
                                
                                <h4 style="margin-top: 24px;">Key Benefits</h4>
                                <ul style="padding-left: 20px; line-height: 1.8;">
                                    <li><strong>Understand Drivers:</strong> See exactly which inputs caused valuation changes</li>
                                    <li><strong>Quantify Impact:</strong> Measure the dollar impact of each input change</li>
                                    <li><strong>Compare Scenarios:</strong> Understand differences between models or time periods</li>
                                    <li><strong>Risk Management:</strong> Identify which inputs pose the greatest risk</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attribution Results -->
                <div class="section" id="attributionResults" style="display: none; position: relative;">
                    <button class="ai-explanation-icon" onclick="app.showAIExplanation('attributionResults', event)" title="AI Analysis">
                        <i data-lucide="sparkles"></i>
                    </button>
                    <h3><i data-lucide="bar-chart-3"></i> Attribution Breakdown</h3>
                    
                    <!-- Summary Cards -->
                    <div class="metrics-grid" style="margin-bottom: var(--spacing-lg);">
                        <div class="metric-card-small">
                            <div class="metric-label-small">Total Change</div>
                            <div class="metric-value-small" id="attributionTotalChange">--</div>
                        </div>
                        <div class="metric-card-small">
                            <div class="metric-label-small">Delta PnL</div>
                            <div class="metric-value-small" id="attributionDeltaPnL">--</div>
                        </div>
                        <div class="metric-card-small">
                            <div class="metric-label-small">Gamma PnL</div>
                            <div class="metric-value-small" id="attributionGammaPnL">--</div>
                        </div>
                        <div class="metric-card-small">
                            <div class="metric-label-small">Vega PnL</div>
                            <div class="metric-value-small" id="attributionVegaPnL">--</div>
                        </div>
                        <div class="metric-card-small">
                            <div class="metric-label-small">Theta PnL</div>
                            <div class="metric-value-small" id="attributionThetaPnL">--</div>
                        </div>
                        <div class="metric-card-small">
                            <div class="metric-label-small">Rho PnL</div>
                            <div class="metric-value-small" id="attributionRhoPnL">--</div>
                        </div>
                    </div>

                    <!-- Attribution Chart -->
                    <div class="chart-container-half">
                        <h3>Attribution Breakdown</h3>
                        <canvas id="attributionChart"></canvas>
                    </div>

                    <!-- Detailed Attribution Table -->
                    <div class="section" style="margin-top: var(--spacing-lg);">
                        <h3><i data-lucide="table"></i> Detailed Attribution</h3>
                        <div class="table-container">
                            <table class="data-table" id="attributionTable">
                                <thead>
                                    <tr>
                                        <th>Input</th>
                                        <th>Change</th>
                                        <th>Delta PnL</th>
                                        <th>Gamma PnL</th>
                                        <th>Vega PnL</th>
                                        <th>Total Contribution</th>
                                        <th>% of Total</th>
                                    </tr>
                                </thead>
                                <tbody id="attributionTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VaR (Value at Risk) View -->
            <div id="var" class="view">
                <div class="view-header">
                    <h2 style="display: flex; align-items: center; gap: var(--spacing-sm);">
                        Value at Risk (VaR)
                        <button class="icon-button" id="varInfoBtn" title="VaR Overview" style="margin-left: 4px;">
                            <i data-lucide="info"></i>
                        </button>
                    </h2>
                    <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                        <select id="varMethodSelect" class="input-field" style="min-width: 200px;">
                            <option value="greeks">Greeks-Based VaR</option>
                            <option value="monte-carlo">Monte Carlo VaR</option>
                            <option value="combined">Combined (Greeks + Monte Carlo)</option>
                        </select>
                        <select id="varConfidenceSelect" class="input-field" style="min-width: 150px;">
                            <option value="0.95">95% Confidence</option>
                            <option value="0.99" selected>99% Confidence</option>
                            <option value="0.999">99.9% Confidence</option>
                        </select>
                        <select id="varTimeHorizonSelect" class="input-field" style="min-width: 150px;">
                            <option value="1">1 Day</option>
                            <option value="5">5 Days</option>
                            <option value="10" selected>10 Days</option>
                            <option value="30">30 Days</option>
                            <option value="90">90 Days</option>
                        </select>
                        <button class="btn btn-primary" id="calculateVaRBtn">
                            <i data-lucide="calculator"></i>
                            Calculate VaR
                        </button>
                    </div>
                </div>

                <!-- VaR Info Modal -->
                <div id="varInfoModal" class="modal" style="display: none;" onclick="if(event.target.id === 'varInfoModal') app.closeVaRInfo()">
                    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2><i data-lucide="info"></i> Value at Risk (VaR) Overview</h2>
                            <button class="icon-button" onclick="app.closeVaRInfo()">
                                <i data-lucide="x"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="section">
                                <h3>What is Value at Risk?</h3>
                                <p class="info-text">Value at Risk (VaR) estimates the maximum potential loss in valuation over a specified time period with a given confidence level.</p>
                                
                                <h4 style="margin-top: 24px;">VaR Calculation Methods</h4>
                                <div style="display: grid; grid-template-columns: 1fr; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                                    <div style="padding: var(--spacing-md); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border-color);">
                                        <strong>Greeks-Based VaR</strong>
                                        <p style="margin: var(--spacing-sm) 0 0 0; font-size: 14px; color: var(--text-secondary);">
                                            Uses sensitivity analysis (Greeks) to estimate risk based on input volatility.<br>
                                            <em>Formula:</em> VaR = √(Σ(Delta² × σ²)) × confidence_factor × √time
                                        </p>
                                    </div>
                                    <div style="padding: var(--spacing-md); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border-color);">
                                        <strong>Monte Carlo VaR</strong>
                                        <p style="margin: var(--spacing-sm) 0 0 0; font-size: 14px; color: var(--text-secondary);">
                                            Uses simulation to generate distribution of outcomes and find percentile loss.<br>
                                            <em>Method:</em> Run thousands of scenarios, find percentile loss
                                        </p>
                                    </div>
                                    <div style="padding: var(--spacing-md); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border-color);">
                                        <strong>Combined VaR</strong>
                                        <p style="margin: var(--spacing-sm) 0 0 0; font-size: 14px; color: var(--text-secondary);">
                                            Combines both methods for comprehensive risk assessment.<br>
                                            <em>Benefit:</em> Captures both model sensitivity and distributional risk
                                        </p>
                                    </div>
                                </div>
                                
                                <h4 style="margin-top: 24px;">Understanding VaR Results</h4>
                                <p class="info-text" style="margin-top: var(--spacing-md);">
                                    <strong>Example:</strong> A 99% VaR of $500B over 10 days means there's a 1% chance of losing more than $500B in the next 10 days.
                                </p>
                                
                                <h4 style="margin-top: 24px;">Key Metrics</h4>
                                <ul style="padding-left: 20px; line-height: 1.8;">
                                    <li><strong>VaR Value:</strong> Maximum expected loss at the specified confidence level</li>
                                    <li><strong>VaR %:</strong> VaR as a percentage of current valuation</li>
                                    <li><strong>Expected Shortfall:</strong> Average loss beyond the VaR threshold (Conditional VaR)</li>
                                    <li><strong>Risk Contribution:</strong> Breakdown by component (Earth vs Mars) and method (Greeks vs Monte Carlo)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VaR Results -->
                <div class="section" id="varResults" style="display: none; position: relative;">
                    <button class="ai-explanation-icon" onclick="app.showAIExplanation('varResults', event)" title="AI Analysis">
                        <i data-lucide="sparkles"></i>
                    </button>
                    <div class="ai-explanation-floating-panel" id="aiExplanation-varResults" style="display: none;">
                        <div class="ai-explanation-floating-panel-content">
                            <div class="ai-explanation-floating-panel-header">
                                <h3 style="margin: 0; display: flex; align-items: center; gap: var(--spacing-sm);">
                                    <i data-lucide="sparkles"></i> VaR Analysis
                                </h3>
                                <button class="icon-button" onclick="app.closeFloatingAIExplanation('varResults')" style="padding: 4px;">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                            <div class="ai-explanation-floating-panel-body" id="aiExplanation-varResults-content">
                                <i data-lucide="loader" class="spinning"></i> Loading...
                            </div>
                        </div>
                    </div>
                    <h3><i data-lucide="alert-octagon"></i> VaR Analysis</h3>
                    
                    <!-- Summary Cards -->
                    <div class="metrics-grid" style="margin-bottom: var(--spacing-lg);">
                        <div class="metric-card-small">
                            <div class="metric-label-small">VaR (99%)</div>
                            <div class="metric-value-small" id="varValue">--</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Maximum expected loss</div>
                        </div>
                        <div class="metric-card-small">
                            <div class="metric-label-small">Current Valuation</div>
                            <div class="metric-value-small" id="varCurrentValuation">--</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Base valuation</div>
                        </div>
                        <div class="metric-card-small">
                            <div class="metric-label-small">VaR %</div>
                            <div class="metric-value-small" id="varPercent">--</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">% of valuation</div>
                        </div>
                        <div class="metric-card-small">
                            <div class="metric-label-small">Expected Shortfall</div>
                            <div class="metric-value-small" id="varExpectedShortfall">--</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Conditional VaR</div>
                        </div>
                    </div>

                    <!-- VaR Chart -->
                    <div class="chart-container-half">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); flex-wrap: wrap; gap: var(--spacing-sm);">
                            <h3 style="margin: 0;">VaR Distribution</h3>
                            <div style="display: flex; gap: var(--spacing-sm); align-items: center; flex-wrap: wrap;">
                                <div style="display: flex; gap: var(--spacing-xs); align-items: center; font-size: 11px; color: var(--text-secondary);">
                                    <i data-lucide="zoom-in"></i>
                                    <span>Scroll to zoom, drag to pan</span>
                                </div>
                                <label style="font-size: 12px; color: var(--text-secondary);">Min:</label>
                                <input type="number" id="varChartMin" class="input-field" style="width: 100px; padding: 4px 8px; font-size: 12px;" placeholder="Min $B">
                                <label style="font-size: 12px; color: var(--text-secondary);">Max:</label>
                                <input type="number" id="varChartMax" class="input-field" style="width: 100px; padding: 4px 8px; font-size: 12px;" placeholder="Max $B">
                                <button class="btn btn-secondary" id="varChartReset" style="padding: 4px 12px; font-size: 12px;" title="Reset zoom/pan to default range">
                                    <i data-lucide="refresh-cw"></i> Reset
                                </button>
                            </div>
                        </div>
                        <canvas id="varChart"></canvas>
                    </div>

                    <!-- Component Breakdown -->
                    <div class="section" style="margin-top: var(--spacing-lg);">
                        <h3><i data-lucide="layers"></i> Risk Contribution by Component</h3>
                        <div class="charts-row">
                            <div class="chart-container-half">
                                <h4>Earth Component</h4>
                                <canvas id="varEarthChart"></canvas>
                            </div>
                            <div class="chart-container-half">
                                <h4>Mars Component</h4>
                                <canvas id="varMarsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed VaR Table -->
                    <div class="section" style="margin-top: var(--spacing-lg);">
                        <h3><i data-lucide="table"></i> Detailed VaR Breakdown</h3>
                        <div class="table-container">
                            <table class="data-table" id="varTable">
                                <thead>
                                    <tr>
                                        <th>Component</th>
                                        <th>VaR Contribution</th>
                                        <th>% of Total VaR</th>
                                        <th>Greeks Risk</th>
                                        <th>Monte Carlo Risk</th>
                                    </tr>
                                </thead>
                                <tbody id="varTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ratios & Comparables View -->
            <div id="ratios" class="view">
                <div class="view-header">
                    <h2 style="display: flex; align-items: center; gap: var(--spacing-sm);">
                        Ratios & Comparables
                        <button class="icon-button" id="ratiosInfoBtn" title="Ratios & Comparables Overview" style="margin-left: 4px;">
                            <i data-lucide="info"></i>
                        </button>
                    </h2>
                    <div style="display: flex; gap: var(--spacing-sm); align-items: center; flex-wrap: wrap;">
                        <select id="comparableSectorSelect" class="input-field" style="min-width: 200px;">
                            <option value="space">Space Companies</option>
                            <option value="tech">Tech Companies</option>
                            <option value="telecom">Telecom</option>
                            <option value="aerospace">Aerospace & Defense</option>
                        </select>
                        <button class="btn btn-secondary" id="refreshComparablesBtn" title="Refresh comparable company data from API">
                            <i data-lucide="refresh-cw"></i>
                            Refresh Data
                        </button>
                        <div id="comparablesTimestamp" style="font-size: 12px; color: var(--text-secondary); padding: var(--spacing-xs) var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius);">
                            <i data-lucide="clock"></i> <span>Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Ratios & Comparables Info Modal -->
                <div id="ratiosInfoModal" class="modal" style="display: none;" onclick="if(event.target.id === 'ratiosInfoModal') app.closeRatiosInfo()">
                    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2><i data-lucide="info"></i> Ratios & Comparables Overview</h2>
                            <button class="icon-button" onclick="app.closeRatiosInfo()">
                                <i data-lucide="x"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="section">
                                <h3>What are Valuation Ratios & Comparables?</h3>
                                <p class="info-text">
                                    <strong>Ratios & Comparables</strong> analysis compares SpaceX's valuation metrics against similar companies in the market. This helps determine whether SpaceX is fairly valued, overvalued, or undervalued relative to its peers.
                                </p>
                                
                                <h4 style="margin-top: 24px;">Key Valuation Multiples</h4>
                                <div style="display: grid; grid-template-columns: 1fr; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                                    <div style="padding: var(--spacing-md); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border-color);">
                                        <strong>EV/Revenue</strong>
                                        <p style="margin: var(--spacing-sm) 0 0 0; font-size: 14px; color: var(--text-secondary);">
                                            Enterprise Value divided by Revenue. Lower ratios may indicate undervaluation or lower growth expectations.
                                        </p>
                                    </div>
                                    <div style="padding: var(--spacing-md); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border-color);">
                                        <strong>EV/EBITDA</strong>
                                        <p style="margin: var(--spacing-sm) 0 0 0; font-size: 14px; color: var(--text-secondary);">
                                            Enterprise Value divided by EBITDA. Measures operating profitability relative to enterprise value. Common range: 8-15x for mature companies.
                                        </p>
                                    </div>
                                    <div style="padding: var(--spacing-md); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border-color);">
                                        <strong>P/E Ratio</strong>
                                        <p style="margin: var(--spacing-sm) 0 0 0; font-size: 14px; color: var(--text-secondary);">
                                            Price-to-Earnings ratio. Compares stock price to earnings per share. Higher ratios suggest growth expectations.
                                        </p>
                                    </div>
                                    <div style="padding: var(--spacing-md); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border-color);">
                                        <strong>PEG Ratio</strong>
                                        <p style="margin: var(--spacing-sm) 0 0 0; font-size: 14px; color: var(--text-secondary);">
                                            P/E ratio divided by growth rate. Accounts for growth expectations. PEG < 1 may indicate undervaluation.
                                        </p>
                                    </div>
                                </div>
                                
                                <h4 style="margin-top: 24px;">Comparable Company Analysis</h4>
                                <p class="info-text" style="margin-top: var(--spacing-md);">
                                    This section compares SpaceX against similar companies across different sectors:
                                </p>
                                <ul style="padding-left: 20px; line-height: 1.8; margin-top: var(--spacing-sm);">
                                    <li><strong>Space Companies:</strong> Direct competitors in space technology and launch services</li>
                                    <li><strong>Tech Companies:</strong> High-growth technology companies with similar business models</li>
                                    <li><strong>Telecom:</strong> Companies in satellite communications and connectivity</li>
                                    <li><strong>Aerospace & Defense:</strong> Traditional aerospace and defense contractors</li>
                                </ul>
                                
                                <h4 style="margin-top: 24px;">How to Use This Analysis</h4>
                                <ul style="padding-left: 20px; line-height: 1.8; margin-top: var(--spacing-sm);">
                                    <li><strong>Benchmark Valuation:</strong> Compare SpaceX's multiples against peer averages</li>
                                    <li><strong>Identify Outliers:</strong> Find companies with similar growth profiles</li>
                                    <li><strong>Market Context:</strong> Understand how the market values similar businesses</li>
                                    <li><strong>Valuation Range:</strong> Use peer multiples to estimate fair value range</li>
                                </ul>
                                
                                <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: rgba(255, 193, 7, 0.1); border-left: 3px solid #ffc107; border-radius: var(--radius);">
                                    <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">
                                        <strong>Note:</strong> Data is sourced from public financial APIs. For SpaceX, actual public market data will be available once the company goes public.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ratios & Comparables Tabs -->
                <div class="insights-tabs" style="display: flex; gap: 8px; padding: 0 var(--spacing-lg); margin-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-color);">
                    <button class="insights-tab active" data-tab="dashboard">
                        <i data-lucide="layout-dashboard"></i>
                        <span>Dashboard</span>
                    </button>
                    <button class="insights-tab" data-tab="comparables">
                        <i data-lucide="table"></i>
                        <span>Comparables</span>
                    </button>
                    <button class="insights-tab" data-tab="analysis">
                        <i data-lucide="bar-chart-3"></i>
                        <span>Analysis</span>
                    </button>
                </div>

                <!-- Dashboard Tab -->
                <div class="insights-tab-content active" id="ratiosTab-dashboard">
                    <!-- Current Model Valuation -->
                    <div class="section" style="background: rgba(0, 102, 204, 0.05); border-left: 3px solid var(--primary-color);">
                        <h3><i data-lucide="target"></i> SpaceX Current Valuation</h3>
                        <div class="metrics-grid">
                            <div class="metric-card-small" style="padding: var(--spacing-lg); min-height: 140px;">
                                <div class="metric-label-small" style="font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-sm);">Model Valuation</div>
                                <div class="metric-value-small" id="spacexCurrentValuation" style="font-size: 32px; font-weight: 700; line-height: 1.2; margin: var(--spacing-sm) 0;">--</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: var(--spacing-xs);">From DCF model</div>
                            </div>
                            <div class="metric-card-small" style="padding: var(--spacing-lg); min-height: 140px;">
                                <div class="metric-label-small" style="font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-sm);">Revenue (Est.)</div>
                                <div class="metric-value-small" id="spacexRevenue" style="font-size: 32px; font-weight: 700; line-height: 1.2; margin: var(--spacing-sm) 0;">--</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: var(--spacing-xs);">Annual revenue</div>
                            </div>
                            <div class="metric-card-small" style="padding: var(--spacing-lg); min-height: 140px;">
                                <div class="metric-label-small" style="font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-sm);">EBITDA (Est.)</div>
                                <div class="metric-value-small" id="spacexEbitda" style="font-size: 32px; font-weight: 700; line-height: 1.2; margin: var(--spacing-sm) 0;">--</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: var(--spacing-xs);">Operating profit</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Implied Valuations from Comparables -->
                    <div class="section">
                        <h3><i data-lucide="calculator"></i> Implied Valuations from Comparables</h3>
                        <div id="impliedValuationsContainer">
                            <p style="color: var(--text-secondary); text-align: center; padding: var(--spacing-lg);">
                                Loading comparable companies to calculate implied valuations...
                            </p>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3><i data-lucide="bar-chart-3"></i> Peer Multiples Summary</h3>
                        <div class="metrics-grid">
                            <div class="metric-card-small">
                                <div class="metric-label-small">Avg EV/Revenue</div>
                                <div class="metric-value-small" style="color: var(--text-secondary);">--</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Peer average</div>
                            </div>
                            <div class="metric-card-small">
                                <div class="metric-label-small">Avg EV/EBITDA</div>
                                <div class="metric-value-small" style="color: var(--text-secondary);">--</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Peer average</div>
                            </div>
                            <div class="metric-card-small">
                                <div class="metric-label-small">Avg P/E Ratio</div>
                                <div class="metric-value-small" style="color: var(--text-secondary);">--</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Peer average</div>
                            </div>
                            <div class="metric-card-small">
                                <div class="metric-label-small">Avg PEG Ratio</div>
                                <div class="metric-value-small" style="color: var(--text-secondary);">--</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Peer average</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3><i data-lucide="trending-up"></i> Sector Summary</h3>
                        <div id="ratiosSectorSummary" style="padding: var(--spacing-md); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border-color);">
                            <p style="margin: 0; color: var(--text-secondary);">Select a sector to view summary statistics</p>
                        </div>
                    </div>
                </div>

                <!-- Comparables Tab -->
                <div class="insights-tab-content" id="ratiosTab-comparables">
                    <div class="section">
                        <h3><i data-lucide="table"></i> Comparable Companies</h3>
                        <div class="table-container">
                            <table class="data-table" id="comparablesTable">
                                <thead>
                                    <tr>
                                        <th>Company</th>
                                        <th>Ticker</th>
                                        <th>Market Cap</th>
                                        <th>EV/Revenue</th>
                                        <th>EV/EBITDA</th>
                                        <th>P/E Ratio</th>
                                        <th>PEG Ratio</th>
                                        <th>Revenue Growth</th>
                                    </tr>
                                </thead>
                                <tbody id="comparablesTableBody">
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">
                                            <i data-lucide="loader" class="spinning"></i> Loading comparable companies...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Analysis Tab -->
                <div class="insights-tab-content" id="ratiosTab-analysis">
                    <div class="section">
                        <h3><i data-lucide="bar-chart-3"></i> Multiples Comparison</h3>
                        <div class="charts-row">
                            <div class="chart-container-half">
                                <h4>EV/Revenue Comparison</h4>
                                <canvas id="evRevenueChart"></canvas>
                            </div>
                            <div class="chart-container-half">
                                <h4>EV/EBITDA Comparison</h4>
                                <canvas id="evEbitdaChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3><i data-lucide="trending-up"></i> Growth vs. Valuation</h3>
                        <div class="chart-container-half">
                            <h4>Revenue Growth vs. Valuation Multiples</h4>
                            <canvas id="growthValuationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Models Management View -->
            <div id="models" class="view">
                <div class="view-header">
                    <h2>Saved Valuation Models</h2>
                </div>

                <!-- Model List -->
                <div class="section">
                    <div class="models-toolbar">
                        <div class="models-toolbar-left">
                            <input type="text" id="modelSearch" placeholder="Search models..." class="search-input">
                            <select id="modelSort" class="select-input">
                                <option value="createdAt-desc">Newest First</option>
                                <option value="createdAt-asc">Oldest First</option>
                                <option value="name-asc">Name A-Z</option>
                                <option value="name-desc">Name Z-A</option>
                            </select>
                            <label class="checkbox-label">
                                <input type="checkbox" id="showFavoritesOnly">
                                Favorites Only
                            </label>
                        </div>
                        <div class="models-toolbar-right">
                            <button class="btn btn-secondary btn-sm" id="addModelBtn">
                                <i data-lucide="plus"></i>
                                Add Model
                            </button>
                            <button class="btn btn-primary btn-sm" id="saveCurrentModelBtn">
                                <i data-lucide="save"></i>
                                Save Current Model
                            </button>
                        </div>
                    </div>

                    <div class="models-grid" id="modelsGrid">
                        <!-- Models will be loaded dynamically -->
                    </div>

                    <div class="pagination" id="modelsPagination">
                        <!-- Pagination will be added dynamically -->
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Monte Carlo Confirmation Modal -->
    <div id="monteCarloConfirmModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2><i data-lucide="alert-triangle"></i> Parameters Have Changed</h2>
            </div>
            <div class="modal-body" style="text-align: center; padding: 32px;">
                <div style="margin-bottom: 24px;">
                    <i data-lucide="info" style="width: 48px; height: 48px; color: var(--warning-color);"></i>
                </div>
                <h3 style="margin-bottom: 16px; color: var(--text-primary);">Outdated Simulations Detected</h3>
                <p id="monteCarloConfirmMessage" style="color: var(--text-secondary); margin-bottom: 24px; line-height: 1.6;">
                    <!-- Message will be populated dynamically -->
                </p>
                <div class="actions-bar" style="justify-content: center; gap: 12px;">
                    <button class="btn btn-primary" id="confirmRerunSimulationBtn">
                        <i data-lucide="play"></i> Run New Simulations
                    </button>
                    <button class="btn btn-secondary" id="cancelRerunSimulationBtn">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Monte Carlo Progress Modal -->
    <div id="monteCarloProgressModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2><i data-lucide="dice-6"></i> Running Monte Carlo Simulation</h2>
                <button class="icon-button" id="closeMonteCarloProgressBtn" onclick="app.closeMonteCarloProgress()" style="display: none;">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 32px;">
                <div id="monteCarloProgressSpinner" style="margin-bottom: 24px;">
                    <i data-lucide="loader-2" style="width: 48px; height: 48px; animation: spin 1s linear infinite;"></i>
                </div>
                <h3 id="monteCarloProgressTitle" style="margin-bottom: 16px; color: var(--text-primary);">Parameters Have Changed</h3>
                <p id="monteCarloProgressDescription" style="color: var(--text-secondary); margin-bottom: 24px; line-height: 1.6;">
                    Monte Carlo is calculating new simulations based on the updated parameters.<br>
                    This may take a few moments...
                </p>
                <div class="progress-bar-container" style="width: 100%; background: var(--background); border-radius: 8px; height: 8px; overflow: hidden;">
                    <div id="monteCarloProgressBar" class="progress-bar" style="width: 0%; height: 100%; background: var(--primary-color); transition: width 0.3s;"></div>
                </div>
                <p id="monteCarloProgressText" style="margin-top: 16px; color: var(--text-secondary); font-size: 14px;">
                    Initializing simulation...
                </p>
                <div id="monteCarloProgressComplete" style="display: none; margin-top: 24px;">
                    <button class="btn btn-primary" onclick="app.closeMonteCarloProgress()">
                        <i data-lucide="check"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Modal (for success/error messages) -->
    <div id="notificationModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2 id="notificationTitle"><i data-lucide="info"></i> Notification</h2>
                <button class="modal-close" id="closeNotificationBtn">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 32px;">
                <div style="margin-bottom: 24px;">
                    <i id="notificationIcon" data-lucide="check-circle" style="width: 48px; height: 48px; color: var(--success-color);"></i>
                </div>
                <p id="notificationMessage" style="color: var(--text-secondary); line-height: 1.6;">
                    <!-- Message will be populated dynamically -->
                </p>
                <div class="actions-bar" style="justify-content: center; margin-top: 24px;">
                    <button class="btn btn-primary" id="confirmNotificationBtn">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Monte Carlo Config Modal -->
    <div id="editMonteCarloConfigModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2><i data-lucide="settings"></i> Edit Monte Carlo Configuration</h2>
                <button class="modal-close" id="closeEditMonteCarloConfigBtn">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body" style="max-height: calc(80vh - 140px); overflow-y: auto;">
                <div class="form-group">
                    <label>Number of Runs</label>
                    <select id="editMonteCarloRuns" class="select-input">
                        <option value="1000">1,000 runs (Fast)</option>
                        <option value="5000" selected>5,000 runs (Recommended)</option>
                        <option value="10000">10,000 runs (Slow, High Precision)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editUseCustomDistributions">
                        Use Custom Distribution Parameters
                    </label>
                </div>

                <div id="customDistributionsSection" style="display: none; margin-top: 24px;">
                    <h3 style="margin-bottom: 16px;">Distribution Parameters</h3>
                    
                    <!-- Earth Parameters -->
                    <div class="parameter-edit-group">
                        <h4>Earth Parameters</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Starlink Penetration - StdDev</label>
                                <input type="number" id="editEarthPenetrationStdDev" step="0.01" min="0" max="1" class="input-full">
                            </div>
                            <div class="form-group">
                                <label>Min</label>
                                <input type="number" id="editEarthPenetrationMin" step="0.01" min="0" max="1" class="input-full">
                            </div>
                            <div class="form-group">
                                <label>Max</label>
                                <input type="number" id="editEarthPenetrationMax" step="0.01" min="0" max="1" class="input-full">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Launch Volume - StdDev</label>
                                <input type="number" id="editEarthLaunchStdDev" step="1" min="0" class="input-full">
                            </div>
                            <div class="form-group">
                                <label>Min</label>
                                <input type="number" id="editEarthLaunchMin" step="1" min="0" class="input-full">
                            </div>
                            <div class="form-group">
                                <label>Max</label>
                                <input type="number" id="editEarthLaunchMax" step="1" min="0" class="input-full">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Bandwidth Price Decline - StdDev</label>
                                <input type="number" id="editEarthBandwidthStdDev" step="0.01" min="0" max="1" class="input-full">
                            </div>
                            <div class="form-group">
                                <label>Min</label>
                                <input type="number" id="editEarthBandwidthMin" step="0.01" min="0" max="1" class="input-full">
                            </div>
                            <div class="form-group">
                                <label>Max</label>
                                <input type="number" id="editEarthBandwidthMax" step="0.01" min="0" max="1" class="input-full">
                            </div>
                        </div>
                    </div>

                    <!-- Mars Parameters -->
                    <div class="parameter-edit-group">
                        <h4>Mars Parameters</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>First Colony Year - StdDev</label>
                                <input type="number" id="editMarsColonyStdDev" step="1" min="0" class="input-full">
                            </div>
                            <div class="form-group">
                                <label>Min</label>
                                <input type="number" id="editMarsColonyMin" step="1" min="2020" max="2100" class="input-full">
                            </div>
                            <div class="form-group">
                                <label>Max</label>
                                <input type="number" id="editMarsColonyMax" step="1" min="2020" max="2100" class="input-full">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Population Growth - StdDev</label>
                                <input type="number" id="editMarsPopStdDev" step="0.01" min="0" max="1" class="input-full">
                            </div>
                            <div class="form-group">
                                <label>Min</label>
                                <input type="number" id="editMarsPopMin" step="0.01" min="0" max="1" class="input-full">
                            </div>
                            <div class="form-group">
                                <label>Max</label>
                                <input type="number" id="editMarsPopMax" step="0.01" min="0" max="1" class="input-full">
                            </div>
                        </div>
                    </div>

                    <!-- Financial Parameters -->
                    <div class="parameter-edit-group">
                        <h4>Financial Parameters</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Discount Rate - StdDev</label>
                                <input type="number" id="editFinancialDiscountStdDev" step="0.01" min="0" max="1" class="input-full">
                            </div>
                            <div class="form-group">
                                <label>Min</label>
                                <input type="number" id="editFinancialDiscountMin" step="0.01" min="0" max="1" class="input-full">
                            </div>
                            <div class="form-group">
                                <label>Max</label>
                                <input type="number" id="editFinancialDiscountMax" step="0.01" min="0" max="1" class="input-full">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Dilution Factor - StdDev</label>
                                <input type="number" id="editFinancialDilutionStdDev" step="0.01" min="0" max="1" class="input-full">
                            </div>
                            <div class="form-group">
                                <label>Min</label>
                                <input type="number" id="editFinancialDilutionMin" step="0.01" min="0" max="1" class="input-full">
                            </div>
                            <div class="form-group">
                                <label>Max</label>
                                <input type="number" id="editFinancialDilutionMax" step="0.01" min="0" max="1" class="input-full">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="actions-bar" style="margin-top: 24px;">
                    <button class="btn btn-primary" id="saveMonteCarloConfigBtn">
                        <i data-lucide="save"></i> Save Configuration
                    </button>
                    <button class="btn btn-secondary" id="cancelEditMonteCarloConfigBtn">
                        Cancel
                    </button>
                    <button class="btn btn-secondary" id="resetMonteCarloConfigBtn">
                        <i data-lucide="rotate-ccw"></i> Reset to Defaults
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Simulation Modal -->
    <div id="saveSimulationModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2><i data-lucide="save"></i> Save Monte Carlo Simulation</h2>
                <button class="modal-close" id="closeSaveSimulationBtn">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Simulation Name *</label>
                    <input type="text" id="saveSimulationName" class="input-full" placeholder="e.g., Monte Carlo - Base Model">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="saveSimulationDescription" class="input-full" rows="3" placeholder="Optional description"></textarea>
                </div>
                <div class="actions-bar">
                    <button class="btn btn-primary" id="confirmSaveSimulationBtn">
                        <i data-lucide="save"></i> Save
                    </button>
                    <button class="btn btn-secondary" id="cancelSaveSimulationBtn">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Model Modal -->
    <div id="saveModelModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2><i data-lucide="save"></i> Save Model</h2>
                <button class="modal-close" id="closeSaveModelBtn">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="saveModelName">Model Name *</label>
                    <input type="text" id="saveModelName" class="input-full" placeholder="e.g., Base Model - Q4 2024" required>
                </div>
                <div class="form-group">
                    <label for="saveModelDescription">Description</label>
                    <textarea id="saveModelDescription" class="input-full" rows="3" placeholder="Optional description of this model"></textarea>
                </div>
                <div class="form-group">
                    <label for="saveModelTags">Tags</label>
                    <input type="text" id="saveModelTags" class="input-full" placeholder="e.g., baseline, q4-2024, conservative (comma-separated)">
                    <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">Separate tags with commas</small>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="saveModelFavorite">
                        <span>Mark as favorite</span>
                    </label>
                </div>
                <div class="actions-bar">
                    <button class="btn btn-primary" id="confirmSaveModelBtn">
                        <i data-lucide="save"></i> Save Model
                    </button>
                    <button class="btn btn-secondary" id="cancelSaveModelBtn">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit/Delete Model Modal -->
    <div id="editModelModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2><i data-lucide="edit"></i> Edit Model</h2>
                <button class="modal-close" id="closeEditModelBtn">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editModelName">Model Name *</label>
                    <input type="text" id="editModelName" class="input-full" placeholder="e.g., Base Model - Q4 2024" required>
                </div>
                <div class="form-group">
                    <label for="editModelDescription">Description</label>
                    <textarea id="editModelDescription" class="input-full" rows="3" placeholder="Optional description of this model"></textarea>
                </div>
                <div class="form-group">
                    <label for="editModelTags">Tags</label>
                    <input type="text" id="editModelTags" class="input-full" placeholder="e.g., baseline, q4-2024, conservative (comma-separated)">
                    <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">Separate tags with commas</small>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="editModelFavorite">
                        <span>Mark as favorite</span>
                    </label>
                </div>
                <div class="form-group" id="editModelBaselineGroup" style="display: none;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="editModelBaseline">
                        <span>Mark as baseline model</span>
                    </label>
                    <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block; margin-left: 24px;">Baseline models are used for reconciliation and comparison</small>
                </div>
                <div class="actions-bar" style="margin-top: var(--spacing-lg); border-top: 1px solid var(--border-color); padding-top: var(--spacing-md);">
                    <button class="btn btn-danger" id="deleteModelBtn" style="margin-right: auto;">
                        <i data-lucide="trash-2"></i> Delete Model
                    </button>
                    <button class="btn btn-secondary" id="cancelEditModelBtn">
                        Cancel
                    </button>
                    <button class="btn btn-primary" id="saveEditModelBtn">
                        <i data-lucide="save"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2><i data-lucide="settings"></i> Settings</h2>
                <button class="modal-close" id="closeSettingsBtn">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <!-- Settings Tabs -->
            <div class="help-tabs">
                <button class="help-tab active" data-tab="ai">AI Model</button>
                <button class="help-tab" data-tab="mach33lib">Mach33Lib</button>
                <button class="help-tab" data-tab="financial-api">Financial Data API</button>
                <button class="help-tab" data-tab="general">General</button>
            </div>
            <div class="modal-body" style="max-height: calc(80vh - 140px); overflow-y: auto;">
                <!-- AI Model Tab -->
                <div id="settingsTab-ai" class="help-tab-content active">
                    <div class="help-section">
                        <h3>AI Model Configuration</h3>
                        <p>Select the AI model used for generating insights and explanations. Faster models provide quicker responses, while more powerful models offer deeper analysis.</p>
                        
                        <div class="form-group" style="margin-top: var(--spacing-lg);">
                            <label for="aiModelSelect" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600;">
                                <i data-lucide="sparkles"></i> AI Model
                            </label>
                            <select id="aiModelSelect" class="select-input" style="width: 100%; max-width: 500px;">
                                <optgroup label="Anthropic Claude">
                                    <option value="claude-opus-4-1-20250805">Claude Opus 4.1 (Latest, Most Powerful)</option>
                                    <option value="claude-3-opus-20240229">Claude 3 Opus (Balanced)</option>
                                    <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet (Fast & Capable)</option>
                                    <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku (Fastest)</option>
                                    <option value="claude-3-sonnet-20240229">Claude 3 Sonnet (Legacy)</option>
                                </optgroup>
                                <optgroup label="OpenAI">
                                    <option value="openai:gpt-4o">GPT-4o (Latest, Most Capable)</option>
                                    <option value="openai:gpt-4-turbo">GPT-4 Turbo</option>
                                    <option value="openai:gpt-4">GPT-4</option>
                                    <option value="openai:gpt-3.5-turbo">GPT-3.5 Turbo (Fast)</option>
                                </optgroup>
                                <optgroup label="xAI Grok">
                                    <option value="grok:grok-3">Grok-3 (Latest with X Feed Access)</option>
                                    <option value="grok:grok-beta">Grok Beta (Deprecated - use Grok-3)</option>
                                    <option value="grok:grok-2">Grok-2 (Deprecated - use Grok-3)</option>
                                </optgroup>
                            </select>
                            <p style="margin-top: var(--spacing-sm); font-size: 13px; color: var(--text-secondary);">
                                <strong>Current:</strong> <span id="currentModelDisplay">Loading...</span>
                            </p>
                        </div>
                        
                        <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: rgba(0, 102, 204, 0.05); border-radius: var(--radius); border-left: 3px solid var(--primary-color);">
                            <h4 style="margin-top: 0; margin-bottom: var(--spacing-sm);">
                                <i data-lucide="info"></i> Model Comparison
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); font-size: 13px;">
                                <div>
                                    <strong>Claude Opus 4.1</strong><br>
                                    Best quality, slower<br>
                                    <em>Best for: Deep analysis</em>
                                </div>
                                <div>
                                    <strong>Claude Sonnet/Haiku</strong><br>
                                    Good quality, fast<br>
                                    <em>Best for: Quick insights</em>
                                </div>
                                <div>
                                    <strong>GPT-4o</strong><br>
                                    Excellent quality, fast<br>
                                    <em>Best for: Balanced use</em>
                                </div>
                                <div>
                                    <strong>Grok-3</strong><br>
                                    Latest model with real-time X (Twitter) feed access for enhanced insights
                                    Good quality, real-time data<br>
                                    <em>Best for: Current insights</em>
                                </div>
                            </div>
                            
                            <div style="margin-top: var(--spacing-md); padding: var(--spacing-sm); background: rgba(245, 158, 11, 0.1); border-radius: var(--radius); font-size: 12px; color: var(--text-secondary);">
                                <strong>Note:</strong> OpenAI and Grok require API keys configured in your environment variables (OPENAI_API_KEY, XAI_API_KEY).
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="app.saveAIModelSettings()" style="margin-top: var(--spacing-lg);">
                            <i data-lucide="save"></i> Save Settings
                        </button>
                    </div>
                </div>
                
                <!-- Mach33Lib Tab -->
                <div id="settingsTab-mach33lib" class="help-tab-content">
                    <div class="help-section">
                        <h3>Mach33Lib Configuration</h3>
                        <p>Configure the financial Greeks calculation library. Mach33Lib uses finite difference methods by default, with support for alternative libraries.</p>
                        
                        <div class="form-group" style="margin-top: var(--spacing-lg);">
                            <label for="greeksLibrarySelect" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600;">
                                <i data-lucide="calculator"></i> Greeks Calculation Library
                            </label>
                            <select id="greeksLibrarySelect" class="select-input" style="width: 100%; max-width: 500px;">
                                <option value="mach33lib-finite-difference">Mach33Lib - Finite Difference (Default)</option>
                                <option value="mach33lib-central-difference">Mach33Lib - Central Difference (More Accurate)</option>
                                <option value="mach33lib-monte-carlo">Mach33Lib - Monte Carlo Based (Most Accurate)</option>
                                <option value="custom">Custom Library (Future)</option>
                            </select>
                            <p style="margin-top: var(--spacing-sm); font-size: 13px; color: var(--text-secondary);">
                                <strong>Current:</strong> <span id="currentLibraryDisplay">Loading...</span>
                            </p>
                        </div>
                        
                        <div class="form-group" style="margin-top: var(--spacing-lg);">
                            <label style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600;">
                                <i data-lucide="sliders"></i> Bump Sizes
                            </label>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
                                <div>
                                    <label style="font-size: 13px; color: var(--text-secondary);">Percentage Inputs (%)</label>
                                    <input type="number" id="bumpPercentage" class="input-field" step="0.001" min="0.001" max="0.1" value="0.01" style="width: 100%;">
                                    <small style="color: var(--text-secondary);">Default: 1%</small>
                                </div>
                                <div>
                                    <label style="font-size: 13px; color: var(--text-secondary);">Absolute Inputs (units)</label>
                                    <input type="number" id="bumpAbsolute" class="input-field" step="1" min="1" max="100" value="1" style="width: 100%;">
                                    <small style="color: var(--text-secondary);">Default: 1 unit</small>
                                </div>
                                <div>
                                    <label style="font-size: 13px; color: var(--text-secondary);">Time Inputs (years)</label>
                                    <input type="number" id="bumpTime" class="input-field" step="0.1" min="0.1" max="10" value="1" style="width: 100%;">
                                    <small style="color: var(--text-secondary);">Default: 1 year</small>
                                </div>
                                <div>
                                    <label style="font-size: 13px; color: var(--text-secondary);">Volatility (%)</label>
                                    <input type="number" id="bumpVolatility" class="input-field" step="0.001" min="0.001" max="0.1" value="0.01" style="width: 100%;">
                                    <small style="color: var(--text-secondary);">Default: 1%</small>
                                </div>
                                <div>
                                    <label style="font-size: 13px; color: var(--text-secondary);">Discount Rate (%)</label>
                                    <input type="number" id="bumpRate" class="input-field" step="0.0001" min="0.0001" max="0.01" value="0.001" style="width: 100%;">
                                    <small style="color: var(--text-secondary);">Default: 0.1%</small>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: rgba(0, 102, 204, 0.05); border-radius: var(--radius); border-left: 3px solid var(--primary-color);">
                            <h4 style="margin-top: 0; margin-bottom: var(--spacing-sm);">
                                <i data-lucide="info"></i> Method Comparison
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md); font-size: 13px;">
                                <div>
                                    <strong>Finite Difference</strong><br>
                                    Fast, good accuracy<br>
                                    <em>Best for: Real-time calculations</em>
                                </div>
                                <div>
                                    <strong>Central Difference</strong><br>
                                    More accurate, slightly slower<br>
                                    <em>Best for: Higher precision</em>
                                </div>
                                <div>
                                    <strong>Monte Carlo Based</strong><br>
                                    Most accurate, slower<br>
                                    <em>Best for: Detailed analysis</em>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
                            <button class="btn btn-primary" id="saveMach33LibBtn" onclick="app.saveMach33LibSettings(event)">
                                <i data-lucide="save"></i> Save Settings
                            </button>
                            <button class="btn btn-secondary" id="resetMach33LibBtn" onclick="app.resetMach33LibSettings(event)" title="Reset to default values">
                                <i data-lucide="refresh-cw"></i> Reset to Defaults
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Financial Data API Tab -->
                <div id="settingsTab-financial-api" class="help-tab-content">
                    <div class="help-section">
                        <h3>Financial Data API Configuration</h3>
                        <p>Select the data source for comparable company financial data. Free APIs are available with registration.</p>
                        
                        <div class="form-group" style="margin-top: var(--spacing-lg);">
                            <label for="financialApiSelect" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600;">
                                <i data-lucide="database"></i> Financial Data API Provider
                            </label>
                            <select id="financialApiSelect" class="select-input" style="width: 100%; max-width: 500px;">
                                <option value="yahoo-finance">Yahoo Finance (Default - Free, No API Key Required)</option>
                                <option value="alpha-vantage">Alpha Vantage (Free Tier Available)</option>
                                <option value="financial-modeling-prep">Financial Modeling Prep (Free Tier Available)</option>
                                <option value="sample-data">Sample Data (No API Key Required)</option>
                            </select>
                            <p style="margin-top: var(--spacing-sm); font-size: 13px; color: var(--text-secondary);">
                                <strong>Current:</strong> <span id="currentFinancialApiDisplay">Loading...</span>
                            </p>
                        </div>
                        
                        <!-- Alpha Vantage API Key -->
                        <div id="alphaVantageApiKeyGroup" class="form-group" style="margin-top: var(--spacing-lg);">
                            <label for="alphaVantageApiKey" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600;">
                                <i data-lucide="key"></i> Alpha Vantage API Key
                            </label>
                            <input type="password" id="alphaVantageApiKey" class="input-field" placeholder="Enter your Alpha Vantage API key" style="width: 100%; max-width: 500px;">
                            <p style="margin-top: var(--spacing-sm); font-size: 13px; color: var(--text-secondary);">
                                Get your free API key at <a href="https://www.alphavantage.co/support/#api-key" target="_blank" style="color: var(--primary-color);">alphavantage.co</a>
                            </p>
                        </div>
                        
                        <!-- Financial Modeling Prep API Key -->
                        <div id="financialModelingPrepApiKeyGroup" class="form-group" style="margin-top: var(--spacing-lg); display: none;">
                            <label for="financialModelingPrepApiKey" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600;">
                                <i data-lucide="key"></i> Financial Modeling Prep API Key
                            </label>
                            <input type="password" id="financialModelingPrepApiKey" class="input-field" placeholder="Enter your FMP API key" style="width: 100%; max-width: 500px;">
                            <p style="margin-top: var(--spacing-sm); font-size: 13px; color: var(--text-secondary);">
                                Get your free API key at <a href="https://site.financialmodelingprep.com/developer/docs/" target="_blank" style="color: var(--primary-color);">financialmodelingprep.com</a>
                            </p>
                        </div>
                        
                        <!-- Yahoo Finance Info -->
                        <div id="yahooFinanceInfoGroup" class="form-group" style="margin-top: var(--spacing-lg); display: none;">
                            <div style="padding: var(--spacing-md); background: rgba(0, 102, 204, 0.05); border-radius: var(--radius); border-left: 3px solid var(--primary-color);">
                                <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
                                    <strong>Yahoo Finance:</strong> No API key required! This uses Yahoo Finance's public data endpoint. 
                                    Free and unlimited for personal use. Data includes stock quotes, market cap, and basic financial metrics.
                                </p>
                            </div>
                        </div>
                        
                        <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: rgba(0, 102, 204, 0.05); border-radius: var(--radius); border-left: 3px solid var(--primary-color);">
                            <h4 style="margin-top: 0; margin-bottom: var(--spacing-sm);">
                                <i data-lucide="info"></i> API Comparison
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md); font-size: 13px;">
                                <div>
                                    <strong>Yahoo Finance</strong><br>
                                    Free, unlimited (no API key)<br>
                                    <em>Best for: Real-time quotes & market data</em>
                                </div>
                                <div>
                                    <strong>Alpha Vantage</strong><br>
                                    Free tier: 25 requests/day<br>
                                    <em>Best for: Detailed fundamentals & 100+ data APIs</em>
                                </div>
                                <div>
                                    <strong>Financial Modeling Prep</strong><br>
                                    Free tier: 250 requests/day<br>
                                    <em>Best for: Financial statements & ratios</em>
                                </div>
                                <div>
                                    <strong>Sample Data</strong><br>
                                    No API key required<br>
                                    <em>Best for: Testing & demos</em>
                                </div>
                            </div>
                            
                            <div style="margin-top: var(--spacing-md); padding: var(--spacing-sm); background: rgba(245, 158, 11, 0.1); border-radius: var(--radius); font-size: 12px; color: var(--text-secondary);">
                                <strong>Note:</strong> API keys are stored locally in your browser. For production use, configure API keys in environment variables on the server.
                            </div>
                        </div>
                        
                        <!-- Alpha Vantage FAQ -->
                        <div id="alphaVantageFaqGroup" style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: rgba(0, 102, 204, 0.05); border-radius: var(--radius); border-left: 3px solid var(--primary-color); display: none;">
                            <h4 style="margin-top: 0; margin-bottom: var(--spacing-sm);">
                                <i data-lucide="help-circle"></i> Alpha Vantage FAQ
                            </h4>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                                <p style="margin-top: 0;"><strong>Usage Limits:</strong> Free tier provides up to 25 requests per day. For higher volume, premium membership is available.</p>
                                <p><strong>Data Coverage:</strong> Alpha Vantage offers 100+ data API endpoints covering stocks, forex, crypto, commodities, and economic indicators.</p>
                                <p><strong>Data Adjustments:</strong> Time series data is adjusted for both splits and cash dividends (industry standard). Raw unadjusted data is also available for custom adjustment logic.</p>
                                <p style="margin-bottom: 0;"><strong>Getting Started:</strong> Check out the <a href="https://www.alphavantage.co/documentation/" target="_blank" style="color: var(--primary-color);">official API documentation</a> for detailed information and sample code.</p>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="app.saveFinancialApiSettings()" style="margin-top: var(--spacing-lg);">
                            <i data-lucide="save"></i> Save Settings
                        </button>
                    </div>
                </div>
                
                <!-- General Tab -->
                <div id="settingsTab-general" class="help-tab-content">
                    <div class="help-section">
                        <h3>General Settings</h3>
                        <p>General application settings and preferences.</p>
                        <p style="color: var(--text-secondary); font-style: italic;">More settings coming soon...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating AI Explanation Panel -->
    <div class="ai-explanation-floating-panel" id="aiExplanation-greeksDashboard" style="display: none;">
        <div class="ai-explanation-floating-panel-header">
            <i data-lucide="sparkles"></i>
            <span>AI Analysis - Greeks Dashboard</span>
            <button class="ai-explanation-floating-panel-close" onclick="app.closeFloatingAIExplanation('greeksDashboard')" title="Close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="ai-explanation-floating-panel-content" id="aiExplanation-greeksDashboard-content">
            <i data-lucide="loader" class="spinning"></i> Generating insights...
        </div>
    </div>

    <!-- Floating AI Explanation Panel for Attribution -->
    <div class="ai-explanation-floating-panel" id="aiExplanation-attributionResults" style="display: none;">
        <div class="ai-explanation-floating-panel-header">
            <i data-lucide="sparkles"></i>
            <span>AI Analysis - PnL Attribution</span>
            <button class="ai-explanation-floating-panel-close" onclick="app.closeFloatingAIExplanation('attributionResults')" title="Close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="ai-explanation-floating-panel-content" id="aiExplanation-attributionResults-content">
            <i data-lucide="loader" class="spinning"></i> Generating insights...
        </div>
    </div>

    <!-- Floating Info Panel for Greeks Overview -->
    <div class="ai-explanation-floating-panel" id="infoPanel-greeksOverview" style="display: none;">
        <div class="ai-explanation-floating-panel-header">
            <i data-lucide="info"></i>
            <span>Financial Greeks Overview</span>
            <button class="ai-explanation-floating-panel-close" onclick="app.closeInfoPanel('greeksOverview')" title="Close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="ai-explanation-floating-panel-content">
            <h4 style="margin-top: 0; margin-bottom: var(--spacing-md);">Financial Greeks vs. Sensitivity Curves</h4>
            <p style="margin-bottom: var(--spacing-md);">
                <strong>Financial Greeks</strong> measure the instantaneous rate of change (derivative) at the current point - answering "How sensitive is valuation to a small change right now?"
            </p>
            <p style="margin-bottom: var(--spacing-md);">
                <strong>Sensitivity Curves</strong> show the full relationship across a range - answering "What happens if the input changes from A to B?"
            </p>
            <p style="margin-bottom: var(--spacing-md);">
                Greeks are the mathematical derivatives of sensitivity curves: <strong>Delta = slope at current point</strong>, <strong>Gamma = curvature</strong>.
            </p>
            <div style="margin-top: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                <a href="#sensitivity" onclick="app.showView('sensitivity'); app.closeInfoPanel('greeksOverview');" style="color: var(--primary-color); text-decoration: underline;">
                    <strong>View Sensitivity Curves →</strong>
                </a>
            </div>
            
            <h4 style="margin-top: var(--spacing-lg); margin-bottom: var(--spacing-md);">Overview</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md);">
                <div>
                    <strong>Delta (Δ)</strong>: First-order sensitivity - how valuation changes per unit change in input ($B per 1% change).
                </div>
                <div>
                    <strong>Gamma (Γ)</strong>: Convexity/second-order effects - how Delta changes as input changes.
                </div>
                <div>
                    <strong>Vega (ν)</strong>: Volatility sensitivity - how uncertainty affects valuation.
                </div>
                <div>
                    <strong>Theta (Θ)</strong>: Time decay - how valuation changes over time (especially for Mars option).
                </div>
                <div>
                    <strong>Rho (ρ)</strong>: Discount rate sensitivity - how interest rate changes affect valuation.
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2><i data-lucide="help-circle"></i> Help & Methodology</h2>
                <button class="modal-close" id="closeHelpModal">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <!-- Help Tabs -->
            <div class="help-tabs">
                <button class="help-tab active" data-tab="principles">Principles</button>
                <button class="help-tab" data-tab="method">Method</button>
                <button class="help-tab" data-tab="process">Process</button>
                <button class="help-tab" data-tab="stress">Stress Testing</button>
            </div>
            <div class="modal-body" style="max-height: calc(80vh - 140px); overflow-y: auto;">

                <!-- Principles Tab -->
                <div id="helpTab-principles" class="help-tab-content active">
                        <div class="help-section">
                        <h3>Core Principles</h3>
                        <p>This application implements the <strong>ARK × Mach33 SpaceX Valuation Model</strong>, a scenario-weighted, option-embedded, long-horizon enterprise valuation framework.</p>
                        
                        <h4>1. Dual-Planet Infrastructure</h4>
                        <p>SpaceX is modeled as a dual-planet infrastructure company with:</p>
                        <ul>
                            <li><strong>Earth Operations:</strong> Cash-flow constrained, following traditional infrastructure economics</li>
                            <li><strong>Mars Operations:</strong> Physics-constrained, following real-options theory</li>
                        </ul>
                        <p>This separation is structurally essential because they obey different time constants, risk regimes, and discounting logic.</p>

                        <h4>2. Bandwidth as Primitive Economic Unit</h4>
                        <p>Starlink value is anchored on <strong>delivered bandwidth capacity</strong>, not subscriber counts or ARPU alone. This aligns with physical reality:</p>
                        <ul>
                            <li>Satellites → Capacity</li>
                            <li>Capacity → Throughput</li>
                            <li>Throughput → Economic utility</li>
                        </ul>
                        <p>Bandwidth is the conserved quantity, similar to energy in utilities or ton-miles in logistics.</p>

                        <h4>3. Capacity-Driven TAM Expansion</h4>
                        <p>Rather than asking "What % of telecom does SpaceX capture?", the model asks:</p>
                        <p><strong>"How large does the market become once this capacity exists?"</strong></p>
                        <p>Starlink does not compete inside a fixed market—it creates markets that cannot exist without it. This avoids the classic mistake of applying terrestrial telecom TAM logic to orbital infrastructure.</p>

                        <h4>4. Real-Options Logic</h4>
                        <p>Mars is treated as a <strong>call option</strong> with:</p>
                        <ul>
                            <li>Asymmetric payoff (high upside, limited downside)</li>
                            <li>High uncertainty</li>
                            <li>Long maturity</li>
                            <li>Enormous convexity</li>
                        </ul>
                        <p>Critically, failure does not zero Earth value, while success dominates the terminal value distribution. This is mathematically correct for SpaceX—a conventional WACC-based DCF would systematically misprice this structure.</p>

                        <h4>5. Time Horizon Philosophy</h4>
                        <p>The model uses <strong>2030 and 2040 anchor points</strong>, which are:</p>
                        <ul>
                            <li>Aggressive by financial standards</li>
                            <li>Conservative by civilizational infrastructure standards</li>
                        </ul>
                        <p>This framing assumes technological learning curves dominate macro volatility and institutional continuity persists.</p>
                    </div>
                </div>

                <!-- Method Tab -->
                <div id="helpTab-method" class="help-tab-content">
                    <div class="help-section">

                        <h3>Valuation Methodology</h3>
                        
                        <h4>Earth Operations Valuation</h4>
                        <p>Earth operations generate cash flows through:</p>
                        <ul>
                            <li><strong>Starlink:</strong> TAM-based revenue model using GDP growth, inflation, penetration rate, and revenue multiple</li>
                            <li><strong>Starshield:</strong> Estimated as 10% of Starlink revenue</li>
                            <li><strong>Launch Services:</strong> Breakdown between Starship (80%) and Falcon 9 (20%)</li>
                        </ul>
                        <p><strong>Valuation Method:</strong> EBITDA Multiple (18x) applied to final year EBITDA for 2030 horizon. For longer horizons, discounted cash flow with terminal value.</p>

                        <h4>Mars Operations Valuation</h4>
                        <p>Mars operations are valued using real-options theory:</p>
                        <ul>
                            <li><strong>Underlying Value:</strong> Present value of future Mars cash flows</li>
                            <li><strong>Strike Price:</strong> Cost to establish first colony</li>
                            <li><strong>Time to Expiry:</strong> Years until first permanent settlement</li>
                            <li><strong>Volatility:</strong> Based on transport cost decline and population growth assumptions</li>
                        </ul>
                        <p>The model accounts for multiple scenarios (success, delay, failure) with probability-weighted expected values.</p>

                        <h4>Detailed Calculations</h4>
                        <p>The model includes granular tracking of:</p>
                        <ul>
                            <li><strong>Launch Capacity:</strong> Rockets manufactured, available, retired, and reserved for Mars</li>
                            <li><strong>Satellite Constellation:</strong> Satellites launched, deorbited, and active; bandwidth capacity</li>
                            <li><strong>Capital Expenditures:</strong> Satellite, rocket, and facility capex</li>
                            <li><strong>Cost Breakdown:</strong> Satellite manufacturing/operations, launch costs, depreciation</li>
                            <li><strong>Cash Flow:</strong> Revenue - Costs - Capex = Free Cash Flow</li>
                        </ul>

                        <h4>Key Assumptions</h4>
                        <ul>
                            <li><strong>Time Horizon:</strong> Aggressive 2030/2040 anchor points (conservative by infrastructure standards)</li>
                            <li><strong>Discount Rate:</strong> Default 12% (can be adjusted)</li>
                            <li><strong>EBITDA Multiple:</strong> 18x for 2030 valuation (as per Excel model)</li>
                            <li><strong>Dilution:</strong> 15% default (accounts for future capital raises)</li>
                            <li><strong>Starlink Revenue Model:</strong> TAM-based with penetration and revenue multiple</li>
                            <li><strong>Mars Option:</strong> Black-Scholes framework adapted for real options</li>
                        </ul>

                        <h4>Limitations & Considerations</h4>
                        <ul>
                            <li>Mars political economy and governance frameworks are not deeply modeled</li>
                            <li>Discount rate assumptions are philosophical choices, not empirically derived</li>
                            <li>Competition from nationalized LEO constellations could impact pricing power</li>
                            <li>Model assumes technological learning curves dominate macro volatility</li>
                            <li>Institutional continuity is assumed to persist</li>
                        </ul>
                    </div>
                </div>

                <!-- Process Tab -->
                <div id="helpTab-process" class="help-tab-content">
                    <div class="help-section">

                        <h3>Process & Workflow</h3>
                        
                        <h4>1. Input Parameters</h4>
                        <p>Navigate to the <strong>Inputs</strong> tab to set:</p>
                        <ul>
                            <li><strong>Earth Operations:</strong> Starlink penetration, bandwidth price decline, launch volume, launch price decline</li>
                            <li><strong>Mars Operations:</strong> First colony year, transport cost decline, population growth, industrial bootstrapping</li>
                            <li><strong>Financial:</strong> Discount rate, dilution factor, terminal growth rate</li>
                        </ul>

                        <h4>2. Calculate Base Valuation</h4>
                        <p>Click <strong>Calculate Valuation</strong> to run the model. The system will:</p>
                        <ul>
                            <li>Calculate year-by-year projections for Earth operations</li>
                            <li>Compute Mars real-options value</li>
                            <li>Apply dilution adjustments</li>
                            <li>Generate detailed capacity, constellation, and cash flow data</li>
                        </ul>
                        <p>This gives you a <strong>point estimate</strong> based on your specific input assumptions.</p>

                        <h4>3. Analyze Results</h4>
                        <p>View results in multiple ways:</p>
                        <ul>
                            <li><strong>Dashboard:</strong> High-level metrics, valuation breakdown, charts</li>
                            <li><strong>Earth Tab:</strong> Detailed Earth operations analysis, revenue breakdown, cash flow projections</li>
                            <li><strong>Mars Tab:</strong> Mars option analysis, population projections, scenario breakdown</li>
                        </ul>

                        <h4>4. Advanced Analysis Tools</h4>
                        
                        <h5>Sensitivity Curves</h5>
                        <p>Test the impact of individual variables on valuation:</p>
                        <ul>
                            <li>Select a variable (e.g., Starlink penetration, discount rate)</li>
                            <li>Set a range (min, max, steps)</li>
                            <li>View how valuation changes across the range</li>
                            <li>Identifies which variables have the most impact</li>
                        </ul>
                        <p><strong>Use Case:</strong> Understand which assumptions drive valuation most significantly.</p>

                        <h5>Monte Carlo Simulation</h5>
                        <p><strong>How Monte Carlo Fits Into the Process:</strong></p>
                        <p>While the base calculation gives you a point estimate, Monte Carlo simulation addresses uncertainty by:</p>
                        <ul>
                            <li><strong>Running thousands of simulations</strong> (default: 5,000 runs)</li>
                            <li><strong>Randomizing inputs</strong> based on probability distributions for each variable</li>
                            <li><strong>Generating a distribution</strong> of possible outcomes rather than a single value</li>
                            <li><strong>Providing statistical insights:</strong> mean, median, percentiles (10th, 90th), quartiles, standard deviation</li>
                        </ul>
                        <p><strong>Process:</strong></p>
                        <ol>
                            <li>Set base inputs (your best estimates)</li>
                            <li>Run Monte Carlo simulation</li>
                            <li>Review the distribution histogram to see the range of possible valuations</li>
                            <li>Analyze statistics to understand:
                                <ul>
                                    <li>Expected value (mean)</li>
                                    <li>Median (50th percentile)</li>
                                    <li>Confidence intervals (10th-90th percentile range)</li>
                                    <li>Risk assessment (standard deviation)</li>
                                </ul>
                            </li>
                        </ol>
                        <p><strong>Use Case:</strong> When you want to understand the <strong>range of possible outcomes</strong> given uncertainty in inputs, rather than relying on a single point estimate. This is especially valuable for Mars operations where uncertainty is high.</p>
                        <p><strong>Key Insight:</strong> Monte Carlo reveals that even with uncertain inputs, the valuation distribution may show strong central tendencies, or it may reveal significant tail risks.</p>

                        <h5>Scenario Comparison</h5>
                        <p>Compare different time horizons and scopes:</p>
                        <ul>
                            <li>2030 Earth Only</li>
                            <li>2030 Earth & Mars</li>
                            <li>2040 Earth & Mars</li>
                        </ul>
                        <p><strong>Use Case:</strong> Understand how time horizon and Mars inclusion affect valuation.</p>

                        <h4>5. Save & Manage Models</h4>
                        <p>Save your valuation models for future reference:</p>
                        <ul>
                            <li>Click <strong>Save Current Model</strong> to store inputs and results</li>
                            <li>Models are automatically recalculated with latest logic when loaded</li>
                            <li>Use tags and favorites to organize models</li>
                            <li>Duplicate models to create variations</li>
                        </ul>

                        <h4>Recommended Workflow</h4>
                        <ol>
                            <li><strong>Start with base inputs</strong> - Use default values or your best estimates</li>
                            <li><strong>Calculate base valuation</strong> - Get your point estimate</li>
                            <li><strong>Run sensitivity curves</strong> - See how valuation changes across input ranges</li>
                            <li><strong>Run Monte Carlo simulation</strong> - Understand the distribution of outcomes</li>
                            <li><strong>Run stress tests</strong> - Evaluate downside scenarios</li>
                            <li><strong>Compare scenarios</strong> - See how different horizons affect results</li>
                            <li><strong>Save models</strong> - Document your analysis</li>
                        </ol>

                        <h3>Technical Notes</h3>
                        <ul>
                            <li>All values are displayed in billions (B) or trillions (T)</li>
                            <li>Cash flows are discounted to present value using the specified discount rate</li>
                            <li>Year-by-year projections track capacity, constellation, capex, and costs</li>
                            <li>Models saved with old calculation logic are automatically updated when loaded</li>
                            <li>Monte Carlo uses normal distributions for input randomization (can be customized)</li>
                        </ul>

                        <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #e0e0e0;">
                            <p style="color: #666; font-size: 14px;">
                                <strong>Note:</strong> This model is designed to force the correct questions about civilizational-scale infrastructure valuation, not to provide definitive answers. It treats SpaceX as a capacity-creation company where value follows physics and coordination, not traditional demand curves.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Stress Testing Tab -->
                <div id="helpTab-stress" class="help-tab-content">
                    <div class="help-section">
                        <h3>Stress Testing</h3>
                        <p><strong>How Stress Testing Fits Into the Process:</strong></p>
                        <p>While Monte Carlo simulation explores the <strong>distribution of outcomes</strong> under normal uncertainty, stress testing evaluates <strong>specific adverse scenarios</strong> and failure modes. It answers: "What happens if things go wrong?"</p>
                        
                        <h4>What Stress Testing Does</h4>
                        <ul>
                            <li><strong>Tests extreme scenarios:</strong> Evaluates what happens under adverse conditions</li>
                            <li><strong>Identifies failure modes:</strong> Reveals which assumptions, if violated, would most impact valuation</li>
                            <li><strong>Quantifies downside risk:</strong> Shows how much value could be lost in worst-case scenarios</li>
                            <li><strong>Validates model robustness:</strong> Ensures the valuation model behaves reasonably under stress</li>
                        </ul>
                        
                        <h4>Predefined Stress Scenarios</h4>
                        <p>The application includes three predefined stress scenarios:</p>
                        <ul>
                            <li><strong>Mars Delay:</strong> First colony delayed to 2060 (tests impact of Mars timeline slippage)
                                <ul>
                                    <li>Modifies: <code>mars.firstColonyYear = 2060</code></li>
                                    <li>Impact: Reduces Mars option value due to longer time to expiry</li>
                                    <li>Use Case: Test resilience if Mars colonization is delayed</li>
                                </ul>
                            </li>
                            <li><strong>Competition:</strong> Starlink penetration cut in half (tests impact of competitive pressure)
                                <ul>
                                    <li>Modifies: <code>earth.starlinkPenetration = baseValue × 0.5</code></li>
                                    <li>Impact: Reduces Earth revenue significantly (penetration is highly sensitive)</li>
                                    <li>Use Case: Test impact of competitive LEO constellations or market share loss</li>
                                </ul>
                            </li>
                            <li><strong>Mars Failure:</strong> Zero population growth, no industrial bootstrapping (tests complete Mars failure)
                                <ul>
                                    <li>Modifies: <code>mars.populationGrowth = 0</code>, <code>mars.industrialBootstrap = false</code></li>
                                    <li>Impact: Eliminates Mars value growth, reduces option value</li>
                                    <li>Use Case: Test worst-case scenario where Mars colony fails to scale</li>
                                </ul>
                            </li>
                        </ul>
                        
                        <h4>Custom Stress Scenarios</h4>
                        <p>You can define your own adverse conditions by modifying any input parameter:</p>
                        <ul>
                            <li>Adjust Earth operations inputs (penetration, pricing, launch volume)</li>
                            <li>Modify Mars operations inputs (colony year, cost decline, growth)</li>
                            <li>Change financial parameters (discount rate, dilution, terminal growth)</li>
                            <li>Test specific failure modes or market conditions</li>
                        </ul>
                        <p><strong>Example Custom Scenarios:</strong></p>
                        <ul>
                            <li>Regulatory risk: Reduce launch volume by 50%</li>
                            <li>Technology failure: Increase bandwidth price decline rate</li>
                            <li>Capital constraints: Increase dilution factor</li>
                            <li>Market disruption: Reduce terminal growth rate</li>
                        </ul>
                        
                        <h4>Process</h4>
                        <ol>
                            <li><strong>Start with base valuation:</strong> Calculate your base case point estimate</li>
                            <li><strong>Select scenario:</strong> Choose a predefined scenario or create a custom one</li>
                            <li><strong>Run stress test:</strong> The system recalculates valuation with modified inputs</li>
                            <li><strong>Compare results:</strong>
                                <ul>
                                    <li>Absolute value difference (base vs. stress)</li>
                                    <li>Percentage change</li>
                                    <li>Which components (Earth/Mars) are most affected</li>
                                    <li>Breakdown of value impact</li>
                                </ul>
                            </li>
                            <li><strong>Analyze impact:</strong> Identify which assumptions drive the stress impact</li>
                            <li><strong>Iterate:</strong> Test multiple scenarios to understand risk profile</li>
                        </ol>
                        
                        <h4>Interpreting Results</h4>
                        <p>When reviewing stress test results, consider:</p>
                        <ul>
                            <li><strong>Magnitude of Impact:</strong> How much does valuation change?</li>
                            <li><strong>Asymmetry:</strong> Is the impact symmetric or does it favor upside/downside?</li>
                            <li><strong>Component Breakdown:</strong> Which part (Earth/Mars) is more sensitive?</li>
                            <li><strong>Relative to Base:</strong> Is the stress scenario still valuable, or does it destroy value?</li>
                            <li><strong>Probability:</strong> How likely is this scenario? (Stress testing doesn't assign probabilities)</li>
                        </ul>
                        
                        <h4>Use Cases</h4>
                        <ul>
                            <li><strong>Risk Assessment:</strong> Understand downside exposure and worst-case scenarios</li>
                            <li><strong>Assumption Validation:</strong> Identify which assumptions are most critical to valuation</li>
                            <li><strong>Scenario Planning:</strong> Prepare for adverse market conditions or execution failures</li>
                            <li><strong>Model Validation:</strong> Ensure the model produces reasonable results under extreme conditions</li>
                            <li><strong>Investment Decision Support:</strong> Understand risk-adjusted returns and downside protection</li>
                            <li><strong>Due Diligence:</strong> Test model sensitivity to key risk factors</li>
                        </ul>
                        
                        <h4>Key Insights</h4>
                        <ul>
                            <li>Stress testing reveals <strong>asymmetric risks</strong> - some scenarios have disproportionate impact</li>
                            <li>It helps identify <strong>critical assumptions</strong> that, if wrong, would materially change valuation</li>
                            <li>Comparing multiple stress scenarios shows which <strong>failure modes</strong> are most dangerous</li>
                            <li>Stress testing complements Monte Carlo by testing <strong>specific known risks</strong> rather than general uncertainty</li>
                            <li>Results can inform <strong>risk mitigation strategies</strong> and contingency planning</li>
                        </ul>
                        
                        <h4>Difference from Monte Carlo</h4>
                        <p>Understanding when to use each tool:</p>
                        <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
                            <thead>
                                <tr style="background: var(--background);">
                                    <th style="padding: 12px; border: 1px solid var(--border-color); text-align: left;">Aspect</th>
                                    <th style="padding: 12px; border: 1px solid var(--border-color); text-align: left;">Monte Carlo</th>
                                    <th style="padding: 12px; border: 1px solid var(--border-color); text-align: left;">Stress Testing</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid var(--border-color);"><strong>Purpose</strong></td>
                                    <td style="padding: 12px; border: 1px solid var(--border-color);">Explore general uncertainty</td>
                                    <td style="padding: 12px; border: 1px solid var(--border-color);">Test specific adverse scenarios</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid var(--border-color);"><strong>Inputs</strong></td>
                                    <td style="padding: 12px; border: 1px solid var(--border-color);">Randomized based on distributions</td>
                                    <td style="padding: 12px; border: 1px solid var(--border-color);">Specific modified values</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid var(--border-color);"><strong>Output</strong></td>
                                    <td style="padding: 12px; border: 1px solid var(--border-color);">Distribution of outcomes</td>
                                    <td style="padding: 12px; border: 1px solid var(--border-color);">Point estimate for scenario</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid var(--border-color);"><strong>Question</strong></td>
                                    <td style="padding: 12px; border: 1px solid var(--border-color);">"What could happen?"</td>
                                    <td style="padding: 12px; border: 1px solid var(--border-color);">"What happens if X goes wrong?"</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid var(--border-color);"><strong>Best For</strong></td>
                                    <td style="padding: 12px; border: 1px solid var(--border-color);">Understanding range and probabilities</td>
                                    <td style="padding: 12px; border: 1px solid var(--border-color);">Testing known risks and failure modes</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <p><strong>Together:</strong> Monte Carlo shows "what could happen" across the full uncertainty space, while stress testing shows "what happens if X goes wrong" for specific known risks. Both are valuable for comprehensive risk analysis.</p>
                        
                        <h4>Best Practices</h4>
                        <ul>
                            <li><strong>Start with base case:</strong> Always calculate base valuation first</li>
                            <li><strong>Test multiple scenarios:</strong> Don't rely on a single stress test</li>
                            <li><strong>Focus on plausible scenarios:</strong> Test realistic adverse conditions, not impossible ones</li>
                            <li><strong>Document assumptions:</strong> Note which inputs were changed and why</li>
                            <li><strong>Compare systematically:</strong> Use consistent base case for all stress tests</li>
                            <li><strong>Consider correlations:</strong> Some failures may cascade (e.g., Mars delay → reduced launch demand)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script>
        // Register zoom plugin after Chart.js loads
        if (typeof Chart !== 'undefined' && typeof zoomPlugin !== 'undefined') {
            Chart.register(zoomPlugin);
        }
    </script>
    <script src="/js/app.js"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Update collapse icons when sections are toggled
        document.querySelectorAll('.collapsible-section').forEach(section => {
            section.addEventListener('click', function(e) {
                if (e.target.closest('h3')) {
                    const icon = this.querySelector('.collapse-icon');
                    if (icon) {
                        setTimeout(() => {
                            lucide.createIcons();
                        }, 100);
                    }
                }
            });
        });
        
        // Close AI explanation popups when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.ai-explanation-icon') && !e.target.closest('.ai-explanation-popup') && !e.target.closest('.ai-explanation-floating-panel')) {
                document.querySelectorAll('.ai-explanation-popup').forEach(popup => {
                    popup.style.display = 'none';
                });
            }
        });
        
        // Close floating panels with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.ai-explanation-floating-panel').forEach(panel => {
                    if (panel.style.display !== 'none') {
                        const panelId = panel.id.replace('aiExplanation-', '');
                        app.closeFloatingAIExplanation(panelId);
                    }
                });
            }
        });
    </script>

    <!-- Floating Desktop Agent Window -->
    <div id="aiAgentWindow" class="floating-agent-window" style="display: none;">
        <!-- Agent Header -->
        <div class="agent-header" id="agentHeader">
            <div class="agent-header-left">
                <i data-lucide="bot" style="width: 20px; height: 20px; color: var(--primary-color);"></i>
                <div style="display: flex; flex-direction: column; gap: 2px;">
                    <span class="agent-title">Desktop Agent</span>
                    <span id="agentContextBadge" class="agent-context-badge" style="font-size: 10px; color: var(--text-secondary); font-weight: 400;">
                        Dashboard
                    </span>
                </div>
            </div>
            <div class="agent-header-right">
                <button class="icon-button agent-header-btn" id="agentCommentaryToggleBtn" title="Toggle Context Commentary">
                    <i data-lucide="message-square"></i>
                </button>
                <button class="icon-button agent-header-btn" id="agentSettingsBtn" title="Agent Settings">
                    <i data-lucide="settings"></i>
                </button>
                <button class="icon-button agent-header-btn" id="agentCollapseBtn" title="Collapse">
                    <i data-lucide="chevron-down"></i>
                </button>
                <button class="icon-button agent-header-btn" id="agentCloseBtn" title="Close">
                    <i data-lucide="x"></i>
                </button>
            </div>
        </div>

        <!-- Agent Content (collapsible) -->
        <div class="agent-content" id="agentContent">
            <!-- Chat Messages Area -->
            <div class="agent-chat-messages" id="agentChatMessages">
                <div class="agent-message agent-message-system">
                    <div class="message-content">
                        <p>Hello! I'm your Desktop Agent. I can help you analyze SpaceX valuation data, answer questions, and provide insights. How can I assist you today?</p>
                    </div>
                </div>
            </div>

            <!-- Chat Input Area -->
            <div class="agent-chat-input-container">
                <textarea 
                    id="agentChatInput" 
                    class="agent-chat-input" 
                    placeholder="Type your message here..."
                    rows="2"
                ></textarea>
                <button class="btn btn-primary" id="agentSendBtn" title="Send">
                    <i data-lucide="send"></i>
                </button>
            </div>
        </div>
        <!-- Resize Handle -->
        <div class="agent-resize-handle"></div>
    </div>

    <!-- Agent Settings Modal (10-Level System Prompt) -->
    <div id="agentSettingsModal" class="modal" style="display: none;" onclick="if(event.target.id === 'agentSettingsModal') app.closeAgentSettings()">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2><i data-lucide="settings"></i> Agent Settings</h2>
                <button class="icon-button" onclick="app.closeAgentSettings()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Settings Tabs -->
                <div class="insights-tabs" style="display: flex; gap: 8px; padding: 0; margin-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-color);">
                    <button class="insights-tab active" data-agent-tab="system-prompts" onclick="app.switchAgentSettingsTab('system-prompts')">
                        <i data-lucide="layers"></i>
                        <span>System Prompts</span>
                    </button>
                    <button class="insights-tab" data-agent-tab="model-config" onclick="app.switchAgentSettingsTab('model-config')">
                        <i data-lucide="cpu"></i>
                        <span>Model Configuration</span>
                    </button>
                </div>

                <!-- System Prompts Tab -->
                <div id="agentSettingsTab-system-prompts" class="agent-settings-tab-content" style="display: block;">
                    <!-- 10-Level System Prompt Configuration -->
                    <div class="section">
                        <h3>System Prompt Configuration (10 Levels)</h3>
                        <p class="info-text" style="margin-bottom: var(--spacing-md);">
                            Configure the agent's behavior through a hierarchical 10-level system prompt. Each level builds upon the previous ones.
                        </p>
                        
                        <div id="agentSystemPromptInputs">
                            <!-- Levels will be generated dynamically -->
                        </div>

                        <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-sm); justify-content: flex-end;">
                            <button class="btn btn-secondary" id="resetAgentSettingsBtn" onclick="app.resetAgentSystemPrompts()">
                                <i data-lucide="refresh-cw"></i> Reset to Defaults
                            </button>
                            <button class="btn btn-primary" id="saveAgentSettingsBtn" onclick="app.saveAgentSystemPrompts()">
                                <i data-lucide="save"></i> Save Settings
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Model Configuration Tab -->
                <div id="agentSettingsTab-model-config" class="agent-settings-tab-content" style="display: none;">
                    <!-- AI Model Selection -->
                    <div class="section">
                        <h3>AI Model Selection</h3>
                        <div class="form-group">
                            <label>Select AI Model</label>
                            <select id="agentAIModelSelect" class="input-field">
                                <option value="grok:grok-3">Grok-3 (Default)</option>
                                <option value="grok:grok-2">Grok-2</option>
                                <option value="claude-opus-4-1-20250805">Claude Opus 4.1</option>
                                <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                                <option value="gpt-4o">GPT-4o</option>
                            </select>
                            <span class="input-hint">Default: Grok-3. This model will be used for all agent conversations.</span>
                        </div>
                    </div>

                    <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-sm); justify-content: flex-end;">
                        <button class="btn btn-primary" id="saveAgentSettingsBtn2" onclick="app.saveAgentSystemPrompts()">
                            <i data-lucide="save"></i> Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

